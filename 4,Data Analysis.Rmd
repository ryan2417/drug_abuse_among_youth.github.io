---
title: "Data Analysis"
output: html_document
---

```{r}
library(tidyverse)
library(survey)
library(viridis)
library(table1)
library(kableExtra)

knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE,
  echo = FALSE
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d(option = "viridis")
scale_fill_discrete = scale_fill_viridis_d(option = "viridis")
```



```{r, functions}
drug_use_tidy <- function(input_list){
  output <- case_when(input_list == 1 ~ 0,
                      input_list == 2 ~ 1.5,
                      input_list == 3 ~ 6,
                      input_list == 4 ~ 14.5,
                      input_list == 5 ~ 29.5,
                      input_list > 5 ~ 40)
  return(output)
}
drug_use_frequency <- function(input_list){
  output <- case_when(input_list == 0 ~ "No Drug Use",
                      input_list > 0 & input_list < 40 ~ "Light Dose",
                      input_list >= 40 ~ "Heavy Dose")
  factor(output, levels = c("No Drug Use", "Light Dose", "Heavy Dose"))
}

age_tidy <- function(input_list) {
  output <- case_when(input_list == 1 ~ NA_real_,
                      input_list == 2 ~ 8,
                      input_list == 3 ~ 9.5,
                      input_list == 4 ~ 11.5,
                      input_list == 5 ~ 13.5,
                      input_list == 6 ~ 15.5,
                      input_list == 7 ~ 17.5)
}

firstage_tidy <- function(input_list){
  output <- case_when(input_list == 1 ~ "never",
                      input_list == 2 ~ "8 years old or younger",
                      input_list == 3 ~ "9 or 10 years old",
                      input_list == 4 ~ "11 or 12 years old",
                      input_list == 5 ~ "13 or 14 years old",
                      input_list == 6 ~ "15 or 16 years old",
                      input_list == 7 ~ "17 years old or older")
  return(output)
}


association_analysis <- function(input_df, input_name, type){
  if (type == "crude") {
    totaln <- input_df %>% nrow()
    output <- 
      input_df %>% 
      group_by(drug_use_freq, across(all_of(input_name))) %>%
      count() %>% 
      pivot_wider(values_from = n, names_from = starts_with(input_name)) %>%
      mutate_all(~replace(., is.na(.), 0)) %>% 
      ungroup() %>% 
      select(-drug_use_freq) %>% 
      chisq.test() %>% 
      broom::tidy() %>% 
      mutate(cramer_v_effect_size = sqrt(statistic / totaln*parameter),
             stratum = "Overall") %>% 
      select(stratum, statistic, p.value, df = parameter, cramer_v_effect_size)
  } else {
    output <- 
      input_df %>% 
      group_by(across(all_of(type)), drug_use_freq, across(all_of(input_name))) %>%
      count() %>% 
      pivot_wider(values_from = n, names_from = starts_with(input_name), names_prefix = input_name) %>% 
      mutate_all(~replace(., is.na(.), 0)) %>% 
      ungroup() %>% 
      select(-drug_use_freq) %>% 
      nest(data = starts_with(input_name)) %>% 
      mutate(
      chisq_tests = map(.x = data, ~chisq.test(x = .x)),
      chisq_result = map(chisq_tests, broom::tidy),
      totaln = map(data, colSums),
      totaln = map_dbl(.x = totaln, ~reduce(.x, sum))) %>% 
      unnest(chisq_result) %>% 
      mutate(cramer_v_effect_size = sqrt(statistic / totaln*parameter)) %>% 
      select(stratum = starts_with(type), 
             statistic, p.value, 
             df = parameter, 
             cramer_v_effect_size)
  }
  return(output)
}

test_of_association <- function(input_df = yrbss_state_tidy_additional, input_name, table_name){
  output <- tibble(
    type = c("crude", "grade", "sex", "race4")
  )
  output <- output %>% 
    mutate(results = map(.x = type, ~association_analysis(input_df, input_name, type = .x)),
           type = ifelse(type == "race4", "race", type),
           type = factor(type, levels = c("crude","grade", "sex", "race"))) %>% 
    unnest(results)
  kbl(output[, -1], caption = table_name) %>%
    kable_paper("hover", full_width = F) %>% 
    pack_rows(index = table(output$type))
}

```

```{r import data}
yrbss_state_a <- readRDS("data/2019 states a-m.rds")
yrbss_state_z <- readRDS("data/2019 states n-z.rds")
yrbss_state = rbind(yrbss_state_a,yrbss_state_z)
yrbss_state = as_tibble(yrbss_state)
```


```{r tidy data}
yrbss_state_tidy_additional <-
  yrbss_state %>% 
  drop_na(q31, q40, q45, q46, q50, q51, q52, q53, q54, q55, q56, q9, q10, q14, q17, q26, q39,q59, q79, q80, q88, q33, q42, q89, q8, q11, grade, race4, sex) %>% 
  mutate(
    grade = fct_recode(factor(grade, ordered = TRUE), 
                       "9th Grade" = "1",
                       "10th Grade" = "2",
                       "11th Grade" = "3",
                       "12th Grade" = "4"),
    sex = fct_recode(factor(sex, ordered = TRUE), 
                       "female" = "1",
                       "male" = "2"),
    race4 = fct_recode(factor(race4), 
                       "White" = "1",
                       "Black or African American" = "2",
                       "Hispanic/Latino" = "3",
                       "All other Races" = "4"),
    age_initial_alcohol = age_tidy(q40),
    age_initial_smoking = age_tidy(q31),
    age_marijuana = age_tidy(q46),
    marijuana = drug_use_tidy(q45),
    cocaine = drug_use_tidy(q50),
    inhale = drug_use_tidy(q51),
    heroin = drug_use_tidy(q52),
    methamphetamine = drug_use_tidy(q53),
    ecstasy = drug_use_tidy(q54),
    steroid = drug_use_tidy(q55),
    illegal_injection = case_when(q56 == 1 ~ 0,
                                  q56 == 2 ~ 20,
                                  q56 == 3 ~ 40),
    drug_use_sum = rowSums(across(marijuana:illegal_injection)),
    other_drug_sum = rowSums(across(cocaine:illegal_injection)),
    drug_use_freq = drug_use_frequency(drug_use_sum),
    drunk_driving = ifelse(q9 > 1 | q10 > 2, "Yes", "No"),
    drunk_driving = factor(drunk_driving, level = c("Yes", "No")),
    text_driving = ifelse(q11 == 2, "No", "Yes"),
    text_driving = factor(text_driving, level = c("Yes", "No")),
    carrying_weapon = ifelse(q14 == 1, "No", "Yes"),
    carrying_weapon = factor(carrying_weapon, level = c("Yes", "No")),
    suicide_attempt = ifelse(q26 == 1, "Yes", "No"),
    suicide_attempt = factor(suicide_attempt, level = c("Yes", "No")),
    quit_smoke = case_when(q39 == 1 ~ "Never Smoke",
                           q39 == 2 ~ "Yes",
                           q39 == 3 ~ "No"),
    quit_smoke = factor(quit_smoke, level = c("Never Smoke", "Yes", "No")),
    physical_fight = ifelse(q17 == 1, "No", "Yes"),
    physical_fight = factor(physical_fight, level = c("Yes", "No")),
    early_sex = ifelse(q59 > 1 & q59 <= 5 , "Yes", "No"),
    early_sex = factor(early_sex, level = c("Yes", "No")),
    q79 = as.numeric(q79),
    q80 = as.numeric(q80),
    tv_use = case_when(q79 == 1 ~ 0, 
                       q79 == 2 ~ 0.5,
                       q79 > 2 ~ q79 - 2),
    computer_use = q80 - 2,
    computer_use = case_when(q80 == 1 ~ 0, 
                       q80 == 2 ~ 0.5,
                       q80 > 2 ~ q80 - 2),
    screening_use = tv_use + computer_use,
    heavy_screen_use = ifelse(screening_use >= 5, "Yes", "No"),
    sleeping_time = as.numeric(q88) + 3,
    enough_sleep = ifelse(sleeping_time >= 8, "Yes", "No"),
    smoking_status = case_when(q33 == 1 ~ "Never Smoker",
                               q33 >= 2 & q33 <= 5 ~ "Light Smoker",
                               q33 >=6 ~ "Heavy Smoker"),
    smoking_status = factor(smoking_status, level = c("Never Smoker", "Light Smoker", "Heavy Smoker")),
    binge_drinking = case_when(q42 == 1 ~ "No Binge Drinking",
                               q42 >= 2 & q42 <= 4 ~ "Light Binge Drinking",
                               q42 >=5 ~ "Heavy Binge Drinking"),
    binge_drinking = factor(binge_drinking, level = c("No Binge Drinking", "Light Binge Drinking", "Heavy Binge Drinking")),
    seat_belt = case_when(q8 <= 2 ~ "Never or Rarely",
                          q8 == 3 ~ "Sometimes",
                          q8 >= 4 ~ "Most of the time or Always"),
    seat_belt = factor(seat_belt, level = c("Never or Rarely", "Sometimes", "Most of the time or Always")),
    grades_school = case_when(q89 == 1 ~ "Mostly A's",
                       q89 == 2 ~ "Mostly B's",
                       q89 == 3 ~ "Mostly C's",
                       q89 %in% c(4,5) ~ "Mostly Below C's",
                       q89 == 6 ~ "None of these grades",
                       q89 == 7 ~ "Not sure"),
    grades_school = factor(grades_school, level = c("Mostly A's", "Mostly B's", "Mostly C's", "Mostly Below C's", "None of these grades", "Not sure")),
    smoke_age = firstage_tidy(q31),
    alcohol_age = firstage_tidy(q40)
    ) %>% 
  select(drug_use_freq, grade, sex, bmi, race4, drunk_driving, text_driving, carrying_weapon, suicide_attempt, quit_smoke, physical_fight, early_sex, screening_use, heavy_screen_use, sleeping_time, enough_sleep, smoking_status, binge_drinking, seat_belt, grades_school, smoke_age, alcohol_age, age_initial_alcohol, age_initial_smoking)
```

This data analysis uses the resulted data set cleaned by the processing described in data analysis part of [Data]("3,Data Description.html"). According to our motivation, we are interested the relationship between drug use and youth behaviors. In this analysis, we will explore the association between drug use status and each health behavior variables.

There are three kinds of health-related variables and we will use different methods to analyze: 
 - Bi-level categorical variables: drunk driving, carrying weapon, suicide attempt, physical fight, quit-smoking, early-age sexual intercourse, heavy screening usage, enough sleeping
 - Multivariate categorical variables: smoking status, binge drinking status, seat belt usage, GPA(grades in school)
 - Quantitative Variables: initial smoking age, initial drinking age, BMI
 
Here is a table summarized the overall distribution of important variables by drug use status.

## Three-line-table

```{r three-line}

label(yrbss_state_tidy_additional$drunk_driving) = "Drunk Driving"
label(yrbss_state_tidy_additional$text_driving) = "Text Driving"
label(yrbss_state_tidy_additional$carrying_weapon) = "Weapon Carrying"
label(yrbss_state_tidy_additional$suicide_attempt) = "Suicide Attempt"
label(yrbss_state_tidy_additional$quit_smoke) = "Quit Smoking"
label(yrbss_state_tidy_additional$physical_fight) = "Physical Fight"
label(yrbss_state_tidy_additional$early_sex) = "Sexual Intercourse"
label(yrbss_state_tidy_additional$screening_use) = "Screening Use"
label(yrbss_state_tidy_additional$sleeping_time) = "Sleeping Time"
label(yrbss_state_tidy_additional$smoking_status) = "Smoking Status"
label(yrbss_state_tidy_additional$binge_drinking) = "Binge Drinking"
label(yrbss_state_tidy_additional$seat_belt) = "Seat Belt Use"
label(yrbss_state_tidy_additional$grades_school) = "Grades in School"


table1(~ drunk_driving + text_driving + carrying_weapon + suicide_attempt + quit_smoke + physical_fight + early_sex + screening_use + sleeping_time + smoking_status + binge_drinking + seat_belt + grades_school| drug_use_freq, data = yrbss_state_tidy_additional, caption = "Table 1: Distribution of risky behaviors by drug use status")
```



## Hypothesis Testing with visualization of drug status comparison

### Chi-square Test

For bi-level and multi-level categorical variables, we test the independence of two categorical variables, so we should use the R X C chi-square test with hypotheses that 

$$
H_0:\text{There is no association between drug use and the health-related variable of interest}
H_1:\text{There is an association between drug use and the health-related variable of interest}
$$
Other than the chi-square test, we also use the Cramer's V Effect Size to measure the magnitude of the association. It is measure by the manner:
$$
V = \sqrt{\frac{X^2}{n*df}}
$$
where $X^2$ is the chi-square statistic, n is the sample size and $df$ is the degrees of freedom.\

Usually, we use the table below to assess the association through the Cramer's V effect size

```{r}
tibble(
  df = 1:5,
  small_effect = c(0.10, 0.07, 0.06, 0.05, 0.04),
  medium_effect = c(0.3, 0.21, 0.17, 0.15, 0.13),
  large_effect = c(0.5, 0.35, 0.29, 0.25, 0.22)
) %>% 
  knitr::kable()
```


Besides the crude analysis which test the association for all observations in the data set, we also perform a stratified analysis over grade, gender and race to investigate the interaction or confounding effect of these demographic variable on the crude association. 

### 1. Drunk Driving

```{r}
test_of_association(input_name = "drunk_driving", table_name = "Table 2: Drug Use Status vs Drunk Driving")
```


From Table 2, we can see that the overall p-value is significantly small and the p-value of each stratum is significantly small to say that there is association between drug use status and drunk driving. There are differences of effect size among grade, gender and race, implying some interaction effect, but the lowest effect size is still above 0.22, suggesting a moderate association between drug use status and the drunk driving. The effect size demonstrates that the association might be stronger among higher grade, male and white race.

Overall:

```{r}
yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq) %>% 
  summarize(
    prop_drunk_driving = sum(drunk_driving == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_drunk_driving)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "Proportion of Drunk Driving",
       x = "Drug Use Status",
       title = "Plot 1: Proportion of Drunk Driving Among Drug Use Status")
```

Stratified Analysis:

```{r}
yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq, grade) %>% 
  summarize(
    prop_drunk_driving = sum(drunk_driving == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_drunk_driving, fill = grade)) +
  geom_bar(stat = "identity", position = "dodge") + 
  labs(y = "Proportion of Drunk Driving",
       x = "Drug Use Status",
       fill = "Grade",
       title = "Plot 1.1: Proportion of Drunk Driving Among Drug Use Status")


yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq, sex) %>% 
  summarize(
    prop_drunk_driving = sum(drunk_driving == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_drunk_driving, fill = sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "Proportion of Drunk Driving",
       x = "Drug Use Status",
       fill = "Gender",
       title = "Plot 1.2: Proportion of Drunk Driving Among Drug Use Status")


yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq, race4) %>% 
  summarize(
    prop_drunk_driving = sum(drunk_driving == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_drunk_driving, fill = race4)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "Proportion of Drunk Driving",
       x = "Drug Use Status",
       fill = "Race",
       title = "Plot 1.3: Proportion of Drunk Driving Among Drug Use Status")
```

All proportion plots display that an increasing level of drug use frequency has a higher proportion of drunk driving. The dose-response relationship also verifies the existence of the association.

### 2. Cell Phone Use While Driving


```{r}
test_of_association(input_name = "text_driving", table_name = "Table 3: Drug Use Status vs Cell Phone Use During Driving")
```

From Table 3, we can see that not all p-values are significant enough to conclude an association between drug_use status and cell phone use while driving. Since younger children have much less chance of driving than older children, it is make sense that the association is heavily impacted by the grade. However, it also shows no association between drug_use status and cell phone use while driving among Black or African American and all other races. In a conservative perspective, we would conclude that the association between drug_use status and cell phone use while driving is weak, especially among Black or African American and all other races students.

```{r}
yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq) %>% 
  summarize(
    prop_text_driving = sum(text_driving == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_text_driving)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "Proportion of Cell Phone Use During Driving",
       x = "Drug Use Status",
       title = "Plot 2: Proportion of Cell Phone Use During Driving Among Drug Use Status")


yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq, grade) %>% 
  summarize(
    prop_text_driving = sum(text_driving == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_text_driving, fill = grade)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "Proportion of Cell Phone Use During Driving",
       x = "Drug Use Status",
       title = "Plot 2.1: Proportion of Cell Phone Use During Driving Among Drug Use Status")

yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq, sex) %>% 
  summarize(
    prop_text_driving = sum(text_driving == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_text_driving, fill = sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "Proportion of Cell Phone Use During Driving",
       x = "Drug Use Status",
       title = "Plot 2.2: Proportion of Cell Phone Use During Driving Among Drug Use Status")

yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq, race4) %>% 
  summarize(
    prop_text_driving = sum(text_driving == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_text_driving, fill = race4)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "Proportion of Cell Phone Use During Driving",
       x = "Drug Use Status",
       title = "Plot 2.3: Proportion of Cell Phone Use During Driving Among Drug Use Status",
       fill = "race")
```

The overall proportion of cell phone use while driving rises while the level of drug use rises. However, the increment is small and invisible after stratifying by races. Female tends to have higher proportion of cell phone use while driving regardless of drug use status.


### 3. Carrying Weapon

```{r}
test_of_association(input_name = "carrying_weapon", table_name = "Table 4: Drug Use Status vs Carrying Weapon")
```

From Table 4, we can see that all p-values are significantly small to conclude that there is association between drug use status and carrying weapon. The overall effect size is around 0.26 while the lowest effect size is greater than 0.2, so we are confident to say that it is an medium association. However, the large difference of effect size among gender and race implies the interaction effects of gender and race on the association. The association between drug use status and carrying weapon is stronger among male compared to female; the association between drug use status and carrying weapon is strongest among Black or African American and weakest among White.

```{r}
yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq) %>% 
  summarize(
    prop_carrying_weapon = sum(carrying_weapon == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_carrying_weapon)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "Proportion of Carrying Weapon",
       x = "Drug Use Status",
       title = "Plot 3: Proportion of Carrying Weapon Among Drug Use Status")


yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq, grade) %>% 
  summarize(
    prop_carrying_weapon = sum(carrying_weapon == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_carrying_weapon, fill = grade)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "Proportion of Carrying Weapon",
       x = "Drug Use Status",
       title = "Plot 3.1: Proportion of Carrying Weapon Among Drug Use Status")

yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq, sex) %>% 
  summarize(
    prop_carrying_weapon = sum(carrying_weapon == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_carrying_weapon, fill = sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "Proportion of Carrying Weapon",
       x = "Drug Use Status",
       title = "Plot 3.2: Proportion of Carrying Weapon Among Drug Use Status")

yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq, race4) %>% 
  summarize(
    prop_carrying_weapon = sum(carrying_weapon == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_carrying_weapon, fill = race4)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "Proportion of Carrying Weapon",
       x = "Drug Use Status",
       title = "Plot 3.3: Proportion of Carrying Weapon Among Drug Use Status")
```

All plots demonstrate an rising trend of proportion of carrying weapon with the increase level of drug use frequency. The proportion of carrying weapon boosts from light dose drug use to heavy dose drug use. 9th Grade has highest proportion of carrying weapon regardless of drug use status while male has higher proportion of carrying weapon than female ar all drug use status. The proportion of Black and African American students carrying weapon suddenly escalates on heavy dose drug use.  


### 4. Suicide Attempt


```{r}
test_of_association(input_name = "suicide_attempt", table_name = "Table 5: Drug Use Status vs Suicide Attempt")
```

From Table 5, we can see that all p-values are small enough, so we could reject the null hypothesis that there is association between drug use status and suicide attempt. The overall effect size is around 0.33 while the lowest effect size is greater than 0.21, so the association is moderately strong. The interaction effect of race in the association is detected by the difference of effect size among different races. The association is strongest for all other races while it is weakest for Black or African American.

```{r}
yrbss_state_tidy_additional %>%
  group_by(drug_use_freq) %>% 
  summarize(
    prop_suicide_attempt = sum(suicide_attempt == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_suicide_attempt)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "Proportion of Suicide Attempt",
       x = "Drug Use Status",
       title = "Plot 4: Proportion of Suicide Attempt Among Drug Use Status")

yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq, grade) %>% 
  summarize(
    prop_suicide_attempt = sum(suicide_attempt == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_suicide_attempt, fill = grade)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "Proportion of Suicide Attempt",
       x = "Drug Use Status",
       title = "Plot 4.1: Proportion of Suicide Attempt Among Drug Use Status")

yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq, sex) %>% 
  summarize(
    prop_suicide_attempt = sum(suicide_attempt == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_suicide_attempt, fill = sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "Proportion of Suicide Attempt",
       x = "Drug Use Status",
       title = "Plot 4.2: Proportion of Suicide Attempt Among Drug Use Status")

yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq, race4) %>% 
  summarize(
    prop_suicide_attempt = sum(suicide_attempt == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_suicide_attempt, fill = race4)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "Proportion of Suicide Attempt",
       x = "Drug Use Status",
       title = "Plot 4.3: Proportion of Suicide Attempt Among Drug Use Status")
```

Based on these proportion plots, the proportion of suicide attempt increases while the level of drug use frequency goes up. This trend also shows up at each stratum in the stratified plot. The dose-response relationship supports our conclusion about the association between suicide attempt and drug use status. 


### 5. Quit smoking


```{r}
yrbss_state_tidy_quit_smoke <- yrbss_state_tidy_additional %>% filter(quit_smoke != "Never Smoke")
test_of_association(yrbss_state_tidy_quit_smoke, "quit_smoke", "Table 6: Drug Use Status vs Quit Smoking")
```

For quit smoking, we should focus on students who smoke so the number of non-smokers won't bias our results. After filtering out the nonsmokers, the resulted table is in Table 6. Some p-values are not significantly small enough to conclude the association. The overall effect size is around 0.08 and the difference of effect size among grades and among races are significantly large, so the confounding and interaction effects heavily impacted the analysis of association. We would conclude that there is no association between drug use status and quit smoking.   


```{r}
yrbss_state_tidy_quit_smoke %>%
  group_by(drug_use_freq) %>% 
  summarize(
    prop_quit_smoke = sum(quit_smoke == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_quit_smoke)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "Proportion of Quit Smoking",
       x = "Drug Use Status",
       title = "Plot 5: Proportion of Quit Smoking Among Drug Use Status")
  


yrbss_state_tidy_quit_smoke %>% 
  group_by(drug_use_freq, grade) %>% 
  summarize(
    prop_quit_smoke = sum(quit_smoke == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_quit_smoke, fill = grade)) +
  geom_bar(stat = "identity", position = "dodge") + 
  labs(y = "Proportion of Quit Smoking",
       x = "Drug Use Status",
       title = "Plot 5.1: Proportion of Quit Smoking Among Drug Use Status")

yrbss_state_tidy_quit_smoke %>% 
  group_by(drug_use_freq, sex) %>% 
  summarize(
    prop_quit_smoke = sum(quit_smoke == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_quit_smoke, fill = sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "Proportion of Quit Smoking",
       x = "Drug Use Status",
       title = "Plot 5.2: Proportion of Quit Smoking Among Drug Use Status")

yrbss_state_tidy_quit_smoke %>% 
  group_by(drug_use_freq, race4) %>% 
  summarize(
    prop_quit_smoke = sum(quit_smoke == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_quit_smoke, fill = race4)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "Proportion of Quit Smoking",
       x = "Drug Use Status",
       title = "Plot 5.3: Proportion of Quit Smoking Among Drug Use Status")
```

The proportion bar plots do not demonstrate any dose-response relationship since the proportion has no trend of increasing or decreasing across the drug use status. Moreover, the difference of proportion is small between each drug use status. Thus, these plots support the conclusion in the analysis table that there is no association between quit smoking and drug use status.


### 6. Physical Fight

```{r}
test_of_association(input_name = "physical_fight", table_name = "Table 7: Drug Use Status vs Physical Fight")
```

From Table 7, we can see that all p-value are significantly small and the effect size are around 0.4, it is the association between drug use status and physical fight is strong. The effect size over each stratum is very close to each other, so the interaction effect is negligible. 

```{r}
yrbss_state_tidy_additional %>%
  group_by(drug_use_freq) %>% 
  summarize(
    prop_physical_fight = sum(physical_fight == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_physical_fight)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "Proportion of Physical Fight",
       x = "Drug Use Status",
       title = "Plot 6: Proportion of Physical Fight Among Drug Use Status")


yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq, grade) %>% 
  summarize(
    prop_physical_fight = sum(physical_fight == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_physical_fight, fill = grade)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "Proportion of Physical Fight",
       x = "Drug Use Status",
       title = "Plot 6.1: Proportion of Physical Fight Among Drug Use Status")


yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq, sex) %>% 
  summarize(
    prop_physical_fight = sum(physical_fight == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_physical_fight, fill = sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "Proportion of Physical Fight",
       x = "Drug Use Status",
       title = "Plot 6.2: Proportion of Physical Fight Among Drug Use Status")


yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq, race4) %>% 
  summarize(
    prop_physical_fight = sum(physical_fight == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_physical_fight, fill = race4)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "Proportion of Physical Fight",
       x = "Drug Use Status",
       title = "Plot 6.3: Proportion of Physical Fight Among Drug Use Status")
```

The plots illustrate a positive relationship between drug use status and proportion of physical fight, so the proportion of physical fight is higher when the drug use is heavier. This positive trend is stable in each stratum in the stratified plot. The plots are consistent with our conclusion based on the statistical analysis table and enhance the inference about the association between drug use status and physical fight.


### 7. Early-age Sexual Intercourse

```{r}
test_of_association(input_name = "early_sex", table_name = "Table 8: Drug Use Status vs Early-Age Sexual Intercourse")
```
From Table 8, all p-value are significantly small and the effect size are around 0.4, it shows that the association between drug use status and early age sex is strong. The effect size over each stratum is close to each other, so the interaction effect is negligible. 

```{r}
yrbss_state_tidy_additional %>%
  group_by(drug_use_freq) %>% 
  summarize(
    prop_early_sex = sum(early_sex == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_early_sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "Proportion of Early-Age Sexual Intercourse",
       x = "Drug Use Status",
       title = "Plot 7: Proportion of Early-Age Sexual Intercourse Among Drug Use Status")


yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq, grade) %>% 
  summarize(
    prop_early_sex = sum(early_sex == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_early_sex, fill = grade)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "Proportion of Early-Age Sexual Intercourse",
       x = "Drug Use Status",
       title = "Plot 7.1: Proportion of Early-Age Sexual Intercourse Among Drug Use Status")


yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq, sex) %>% 
  summarize(
    prop_early_sex = sum(early_sex == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_early_sex, fill = sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "Proportion of Early-Age Sexual Intercourse",
       x = "Drug Use Status",
       title = "Plot 7.2: Proportion of Early-Age Sexual Intercourse Among Drug Use Status")


yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq, race4) %>% 
  summarize(
    prop_early_sex = sum(early_sex == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_early_sex, fill = race4)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "Proportion of Early-Age Sexual Intercourse",
       x = "Drug Use Status",
       title = "Plot 7.3: Proportion of Early-Age Sexual Intercourse Among Drug Use Status")

```
The plots illustrate a positive relationship between drug use status and proportion of early age sex, so the proportion of early age sex is higher when the drug use is heavier. 
9th Grade has highest proportion of having early age sex regardless of drug use status while male has higher proportion of having early age sex than female ar all drug use status.
Hispanic race has higher proportion of having early age sex when they used heavy dose compared to did not use drug and used light dose drug, which implies a high risky sexual behavior can be triggered when they use heavy dose drug.


### 8. Screening Use

```{r}
yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq, screening_use) %>% 
  count() %>% 
  group_by(drug_use_freq) %>% 
  mutate(
    prop = n/sum(n)
  ) %>% 
  ggplot(aes(x = screening_use, y = prop)) +
  geom_bar(stat = "identity") +
  geom_smooth(se = FALSE) +
  facet_grid(.~drug_use_freq)
```


```{r}
test_of_association(input_name = "heavy_screen_use", table_name = "Table 9: Drug Use Status vs Heavy Screening Use")
```
From Table 9, p-value is not significantly small and effect size is small, implying that there is not a strong association between screening use and drug use frequency. 


```{r}
yrbss_state_tidy_additional %>%
  group_by(drug_use_freq) %>% 
  summarize(
    prop_heavy_screen_use = sum(heavy_screen_use == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_heavy_screen_use)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "Proportion of Heavy Screening Use",
       x = "Drug Use Status",
       title = "Plot 8: Proportion of Heavy Screening Use Among Drug Use Status")


yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq, grade) %>% 
  summarize(
    prop_heavy_screen_use = sum(heavy_screen_use == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_heavy_screen_use, fill = grade)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "Proportion of Heavy Screening Use",
       x = "Drug Use Status",
       title = "Plot 8.1: Proportion of Heavy Screening Use Among Drug Use Status")


yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq, sex) %>% 
  summarize(
    prop_heavy_screen_use = sum(heavy_screen_use == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_heavy_screen_use, fill = sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "Proportion of Heavy Screening Use",
       x = "Drug Use Status",
       title = "Plot 8.2: Proportion of Heavy Screening Use Among Drug Use Status")


yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq, race4) %>% 
  summarize(
    prop_heavy_screen_use = sum(heavy_screen_use == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_heavy_screen_use, fill = race4)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "Proportion of Heavy Screening Use",
       x = "Drug Use Status",
       title = "Plot 8.3: Proportion of Heavy Screening Use Among Drug Use Status")
```
All plots show that there is not too much difference of screening use for different drug use frequency groups.

### 9. Sleeping Time
The density plot shows that heavy dose use subjects sleep less than no drug use subjects and light dose use subjects. Also, more portions of subjects sleep less than 5 hours for heavy dose use compared to no drug use and light dose use subjects. 

```{r}
yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq, sleeping_time) %>% 
  count() %>% 
  group_by(drug_use_freq) %>% 
  mutate(
    prop = n/sum(n)
  ) %>% 
  ggplot(aes(x = sleeping_time, y = prop)) +
  geom_bar(stat = "identity") +
  geom_smooth(se = FALSE) +
  facet_grid(.~drug_use_freq)
```


```{r}
test_of_association(input_name = "enough_sleep", table_name = "Table 10: Drug Use Status vs Enough Sleeping")
```
From Table 10, we can see that the overall p-value is significantly small. However, the effect size is around 0.1, suggesting the association is not that strong. 


```{r}
yrbss_state_tidy_additional %>%
  group_by(drug_use_freq) %>% 
  summarize(
    prop_enough_sleep = sum(enough_sleep == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_enough_sleep)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "Proportion of Enough Sleeping",
       x = "Drug Use Status",
       title = "Plot 9: Proportion of Enough Sleeping Among Drug Use Status")


yrbss_state_tidy_additional %>% 
  mutate(grade = ifelse(is.na(grade), "Missing", as.character(grade))) %>% 
  group_by(drug_use_freq, grade) %>% 
  summarize(
    prop_enough_sleep = sum(enough_sleep == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_enough_sleep, fill = grade)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "Proportion of Enough Sleeping",
       x = "Drug Use Status",
       title = "Plot 9.1: Proportion of Enough Sleeping Among Drug Use Status")


yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq, sex) %>% 
  summarize(
    prop_enough_sleep = sum(enough_sleep == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_enough_sleep, fill = sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "Proportion of Enough Sleeping",
       x = "Drug Use Status",
       title = "Plot 9.2: Proportion of Enough Sleeping Among Drug Use Status")


yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq, race4) %>% 
  summarize(
    prop_enough_sleep = sum(enough_sleep == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_enough_sleep, fill = race4)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(y = "Proportion of Enough Sleeping",
       x = "Drug Use Status",
       title = "Plot 9.3: Proportion of Enough Sleeping Among Drug Use Status")
```
The "enough sleeping" plots shows that heavy dose subjects tend to have least proportions of having enough sleep in all grades and races. Male subjects tend to have more enough sleeping for no drug and use light dose, whereas they tend to have less enough sleeping time when use heavy dose of drug. It infers an association between sleeping time and drug use frequency. 


### 10. Smoking Status

```{r}
test_of_association(input_name = "smoking_status", table_name = "Table 11: Drug Use Status vs Smoking Status")
```

From table 11, we can see that all p-values are significantly small and the effect sizes are around 0.8, which means there is a strong association between drug use and smoking status. The association between drug use and smoking status is weaker among 12th Grade compared to other grades. Among race, All Other Races has the strongest association between drug use and smoking status, and Black or African American has the weakest association.

```{r}
yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq, smoking_status) %>% 
  summarize(n = n()) %>% 
  mutate(prop_smoking_status = n/sum(n)) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_smoking_status, fill = smoking_status)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c('#00CC00', '#FFA500', '#FF4500')) + 
  labs(title = "Plot 10: Proportion of Smoking Status Among Drug Use Status",
       x = "Drug Use Status",
       y = "Proportion",
       fill = "Smoking Status") 
```

```{r}
# Stratified Analysis over Grade
yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq,grade, smoking_status) %>% 
  summarize(n = n()) %>% 
  mutate(prop_smoking_status = n/sum(n)) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_smoking_status, fill = smoking_status)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c('#00CC00', '#FFA500', '#FF4500')) + 
  facet_grid(. ~ grade) +
  labs(title = "Plot 10.1: Proportion of Smoking Status Among Drug Use Status",
       x = "Drug Use Status",
       y = "Proportion",
       fill = "Smoking Status") 
```

```{r}
# Over Gender
yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq,sex, smoking_status,) %>% 
  summarize(n = n()) %>% 
  mutate(prop_smoking_status = n/sum(n)) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_smoking_status, fill = smoking_status)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c('#00CC00', '#FFA500', '#FF4500')) + 
  facet_grid(. ~ sex) +
  labs(title = "Plot 10.2: Proportion of Smoking Status Among Drug Use Status",
       x = "Drug Use Status",
       y = "Proportion",
       fill = "Smoking Status") 
```


```{r}
# Over race
yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq, race4, smoking_status) %>% 
  summarize(n = n()) %>% 
  mutate(prop_smoking_status = n/sum(n)) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_smoking_status, fill = smoking_status)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c('#00CC00', '#FFA500', '#FF4500')) + 
  facet_grid(. ~ race4) + 
  labs(title = "Plot 10.3: Proportion of Smoking Status Among Drug Use Status",
       x = "Drug Use Status",
       y = "Proportion",
       fill = "Smoking Status") 
```


Based on the plot, it shows that heavy dose subjects tend to smoke more because there are more light dose and heavy dose smokers compared to no drug use and light dose drug use subjects. Higher portions of heavy smokers are 9th grade subjects and male gender. In addition, for heavy dose subjects, there are higher portions of heavy smokers in white race compared to Hispanic and Black race.

### 11. Binge Drinking 

```{r}
test_of_association(input_name = "binge_drinking", table_name = "Table 12: Drug Use Status vs Binge Drinking")
```

From table 12, all p-values are significantly small and the overall effect size is as high as 0.9, which indicate that there is a very strong association between drug use and binge drinking. The association between drug use and binge drinking is stronger among 9th Grade compared to other grades, and is stronger among male compared to female. Among race, Black or African American has a relatively weak association between drug use and binge drinking compared to other classification of  races.


```{r}
yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq, binge_drinking) %>% 
  summarize(n = n()) %>% 
  mutate(prop_binge_drinking = n/sum(n)) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_binge_drinking, fill = binge_drinking)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c('#00CC00', '#FFA500', '#FF4500')) + 
  labs(title = "Plot 11: Proportion of Binge Drinking Among Drug Use Status",
       x = "Drug Use Status",
       y = "Proportion",
       fill = "Binge Drinking")
```


```{r}
# Stratified Analysis over Grade
yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq,grade, binge_drinking) %>% 
  summarize(n = n()) %>% 
  mutate(prop_binge_drinking = n/sum(n)) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_binge_drinking, fill = binge_drinking)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c('#00CC00', '#FFA500', '#FF4500')) + 
  facet_grid(. ~ grade) + 
  labs(title = "Plot 11.1: Proportion of Binge Drinking Among Drug Use Status",
       x = "Drug Use Status",
       y = "Proportion",
       fill = "Binge Drinking") 
```


```{r}
# Over Gender
yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq,sex,binge_drinking) %>% 
  summarize(n = n()) %>% 
  mutate(prop_binge_drinking = n/sum(n)) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_binge_drinking, fill = binge_drinking)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c('#00CC00', '#FFA500', '#FF4500')) + 
  facet_grid(. ~ sex) +
  labs(title = "Plot 11.2: Proportion of Binge Drinking Among Drug Use Status",
       x = "Drug Use Status",
       y = "Proportion",
       fill = "Binge Drinking") 
```


```{r}
# Over race
yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq, race4, binge_drinking) %>% 
  summarize(n = n()) %>% 
  mutate(prop_binge_drinking = n/sum(n)) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_binge_drinking, fill = binge_drinking)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c('#00CC00', '#FFA500', '#FF4500')) + 
  facet_grid(. ~ race4) + 
  labs(title = "Plot 11.3: Proportion of Binge Drinking Among Drug Use Status",
       x = "Drug Use Status",
       y = "Proportion",
       fill = "Binge Drinking") 
```

With the increase of drug use, the proportion of no binge drinking decreases, and the proportion of both light and heavy binge drinking increase. The trend of proportion of binge drinking is similar among grade and gender. Among race, no matter in what classification of drug use status, the proportion of no binge drinking among Black or African American is higher than other races, and the proportion of both light and heavy binge drinking is lower than other races.

### 12. Seat belt use 

```{r}
test_of_association(input_name = "seat_belt", table_name = "Table 13: Drug Use Status vs Seat Belt Use")
```

From table 13, all p-values are significantly small,  and generally the effect size is around 0.4, which indicate that there is a strong association between drug use and seat belt use. The association between drug use and seat belt use is the strongest among 12th Grade compared to other grades, and is stronger among White compared to other races. As for gender, the association between drug use and seat belt use among male and female are very similar. 


```{r}
yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq, seat_belt) %>% 
  summarize(n = n()) %>% 
  mutate(prop_seat_belt = n/sum(n)) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_seat_belt, fill = seat_belt)) +
  geom_bar(stat = "identity", position = "dodge") + 
  scale_fill_manual(values = c('#FF4500', '#FFA500', '#00CC00')) +
  labs(title = "Plot 12: Proportion of Seat Belt Use Among Drug Use Status",
       x = "Drug Use Status",
       y = "Proportion",
       fill = "Seat Belt Use")
```

```{r}
# Stratified Analysis over Grade
yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq,grade, seat_belt) %>% 
  summarize(n = n()) %>% 
  mutate(prop_seat_belt = n/sum(n)) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_seat_belt, fill = seat_belt)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c('#FF4500', '#FFA500', '#00CC00')) +
  facet_grid(. ~ grade) +
  labs(title = "Plot 12.1: Proportion of Seat Belt Use Among Drug Use Status",
       x = "Drug Use Status",
       y = "Proportion",
       fill = "Seat Belt Use")
```

```{r}
# Over Gender
yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq,sex, seat_belt) %>% 
  summarize(n = n()) %>% 
  mutate(prop_seat_belt = n/sum(n)) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_seat_belt, fill = seat_belt)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c('#FF4500', '#FFA500', '#00CC00')) +
  facet_grid(. ~ sex) +
  labs(title = "Plot 12.2: Proportion of Seat Belt Use Among Drug Use Status",
       x = "Drug Use Status",
       y = "Proportion",
       fill = "Seat Belt Use") 
```

```{r}
# Over race
yrbss_state_tidy_additional %>% 
  group_by(drug_use_freq, race4, seat_belt) %>% 
  summarize(n = n()) %>% 
  mutate(prop_seat_belt = n/sum(n)) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_seat_belt, fill = seat_belt)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c('#FF4500', '#FFA500', '#00CC00')) +
  facet_grid(. ~ race4) + 
  labs(title = "Plot 12.3: Proportion of Seat Belt Use Among Drug Use Status",
       x = "Drug Use Status",
       y = "Proportion",
       fill = "Seat Belt Use")
```

With the increase of drug use, the proportion of both never and sometimes use seat belt increase, and the proportion of always use seat belt decreases. The trend of proportion of seat belt use is similar among grade, gender, and sex, with a slightly higher proportion of never use seat belt than sometimes use seat belt in heavy drug dose status among male. 

### 13. Grades in school 

```{r}
yrbss_state_tidy_additional_grades_school <- 
  yrbss_state_tidy_additional %>% 
  filter(grades_school %in% c("Mostly A's", "Mostly B's", "Mostly C's","Mostly Below C's"))

```

```{r}
test_of_association(yrbss_state_tidy_additional_grades_school, "grades_school", "Table 14: Drug Use Status vs Grades in School")
```

From table 14, all p-values are significantly small, and the overall effect size is around 0.6, which means that there is a strong association between drug use and GPA. The association between drug use and GPA is the strongest among 11th Grade compared to other grades, and is the weakest among 10th Grade compared to other grades. Also, the association between drug use and GPA is stronger among female than male, and is stronger among students who are classified into all other races compared to students who are classified into other race groups.


```{r}
yrbss_state_tidy_additional_grades_school %>% 
  group_by(drug_use_freq, grades_school) %>% 
  summarize(n = n()) %>% 
  mutate(prop_grades_school = n/sum(n)) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_grades_school, fill = grades_school)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c('#00CC00', '#FFA500', "#CC00FF", '#FF4500')) +
  labs(title = "Plot 13: Proportion of Grades in School Among Drug Use Frequency",
       x = "Drug Use Status",
       y = "Proportion",
       fill = "GPA")
```

```{r}
# Stratified Analysis over Grade
yrbss_state_tidy_additional_grades_school %>% 
  group_by(drug_use_freq,grade, grades_school) %>% 
  summarize(n = n()) %>% 
  mutate(prop_grades_school = n/sum(n)) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_grades_school, fill = grades_school)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c('#00CC00', '#FFA500', "#CC00FF", '#FF4500')) +
  facet_grid(.~ grade) +
  labs(title = "Plot 13.1: Proportion of Grades in School Among Drug Use Frequency",
       x = "Drug Use Status",
       y = "Proportion",
       fill = "GPA")
```

```{r}
# Over Gender
yrbss_state_tidy_additional_grades_school %>% 
  group_by(drug_use_freq,sex, grades_school) %>% 
  summarize(n = n()) %>% 
  mutate(prop_grades_school = n/sum(n)) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_grades_school, fill = grades_school)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c('#00CC00', '#FFA500', "#CC00FF", '#FF4500')) +
  facet_grid(. ~ sex) +
  labs(title = "Plot 13.2: Proportion of Grades in School Among Drug Use Frequency",
       x = "Drug Use Status",
       y = "Proportion",
       fill = "GPA")
```

```{r}
# Over race
yrbss_state_tidy_additional_grades_school %>% 
  group_by(drug_use_freq, race4, grades_school) %>% 
  summarize(n = n()) %>% 
  mutate(prop_grades_school = n/sum(n)) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_grades_school, fill = grades_school)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c('#00CC00', '#FFA500', "#CC00FF", '#FF4500')) +
  facet_grid( . ~ race4) +
  labs(title = "Plot 13.3: Proportion of Grades in School Among Drug Use Frequency",
       x = "Drug Use Status",
       y = "Proportion",
       fill = "GPA")
```

With the increase of drug use, the proportion of Mostly A's decreases, the proportion of Mostly B's has a little change, and the proportion of both mostly C's and below C's increase. The trend is particularly significant among 11th grade compared to other grades, and among all other races compared with White, Black or African American, and Hispanic/Latino.

## Part 3
###2 Smoke initial age, Alcohol initial age, and BMI 
-  More heavy dose subjects started to smoke when they were 9 to 10 and 11 to 12 years old compared to no drug use subjects and light dose drug use subjects. For those who used light dose drug, highest percentage of them started to smoke when they were 13 or 14 years old. For those who used heavy dose drug, most of them started to smoke when they were 15 or 16 years old. It shows that heavy dose subjects start to smoke earlier.
-  Similar things can be seen in drinking alcohol start age. More heavy dose subjects started to drink alcohol when they were 8 years old or younger and 11 or 12 years old compared to no drug use subjects and light dose drug use subjects. For no drug use and light dose drug use subjects, most of them started to drink alcohol when they were 15 or 16 years old. For heavy dose drug use subjects, most of them started to drink alcohol earlier at 13 or 14 years old. It shows that heavy dose subjects also start to drink alcohol earlier.
-  Density plots of BMI are all right-skewed, which means that the mean is greater than the median. Highest percentage of observations fall in 20-30 bmi. The box-plot shows that medians for three dose usage groups are similar. In addition, one-way anova table implies that there is not a significant difference of BMI among three different drug use frequency groups.
## Q11
```{r}
#function for plotting first smoke_age
drug1_smoke=
  yrbss_state_tidy_additional %>%
  mutate(
    smoke_age = firstage_tidy(q31),
  ) %>%
  group_by(drug_use_freq, smoke_age) %>%
  filter(smoke_age != "never") %>%
  summarize(n = n()) %>% 
  mutate(percentage = n/sum(n),
         percent = scales::percent(percentage),
         smoke_age = factor(smoke_age, 
                            levels = c("never",
                                       "8 years old or younger",
                                       "9 or 10 years old",
                                       "11 or 12 years old",
                                       "13 or 14 years old",
                                       "15 or 16 years old",
                                       "17 years old or older"))) %>% 
  ggplot(
       aes(x = drug_use_freq, y = percentage,
           fill = smoke_age)
       ) +
  geom_bar(stat = "identity",                                     
           position = "dodge") +
  scale_y_continuous(breaks = seq(0, 2, .1), 
                     label = scales::percent) +
  geom_text(aes(label = percent),                                     
            size = 3,
            position = position_dodge(0.9)) +
  scale_fill_brewer(palette = "Set2")+
  labs(title="smoke start age")


#boxplot
ggplot(drug1_smoke, 
       aes(x = factor(drug_use_freq), 
           y = age_initial_smoking,fill=factor(drug_use_freq))) +     
  geom_boxplot() +
  theme(
    axis.text.x = element_text(angle = 45, vjust = 0.5, hjust = 1),
    legend.position = "none") +
  labs(title="smoke start age")
```

## Q2-alcohol
-  
```{r}
#function for plotting first alcohol_age
drug1_alcohol=
  yrbss_state_tidy_additional %>%
  mutate(
    alcohol_age = firstage_tidy(q40)
  ) %>%
  drop_na(q40) %>%
  drop_na(drug_use_freq) %>%
  group_by(drug_use_freq, alcohol_age) %>%
    filter(alcohol_age != "never") %>%
  summarize(n = n()) %>% 
  mutate(percentage = n/sum(n),
         percent = scales::percent(percentage),
         alcohol_age = factor(alcohol_age, 
                            levels = c("never",
                                       "8 years old or younger",
                                       "9 or 10 years old",
                                       "11 or 12 years old",
                                       "13 or 14 years old",
                                       "15 or 16 years old",
                                       "17 years old or older"))) %>% 
  ggplot(
       aes(x = drug_use_freq, y = percentage,
           fill = alcohol_age)
       ) +
  geom_bar(stat = "identity",                                     
           position = "dodge") +
  scale_y_continuous(breaks = seq(0, 2, .1), 
                     label = scales::percent) +
  geom_text(aes(label = percent),                                     
            size = 3,
            position = position_dodge(0.9)) +
  scale_fill_brewer(palette = "Set2")+
  labs(title="alcohol start age")

#boxplot
ggplot(drug1_alcohol, 
       aes(x = factor(drug_use_freq), 
           y = age_initial_alcohol,fill=factor(drug_use_freq))) +        
  geom_boxplot() +
  theme(
    axis.text.x = element_text(angle = 45, vjust = 0.5, hjust = 1),
    legend.position = "none") +
  labs(title="alcohol start age")

```

## Q3-BMI
```{r}
BMI =
  yrbss_state_tidy_additional %>%
  drop_na(drug_use_freq) %>%
  drop_na(sex)

BMI %>%
  ggplot(aes(x = factor(drug_use_freq), 
           y = bmi,fill=factor(drug_use_freq))) +
  geom_boxplot() +
  facet_grid(. ~ sex) +  
  theme(
    axis.text.x = element_text(angle = 45, vjust = 0.5, hjust = 1),
    legend.position = "none")+
  labs(title = "BMI for no drug use/light dose/heavy dose subjects")

density_plot=
  ggplot(BMI, aes(x=bmi, color=sex)) +
  geom_density()+
  geom_vline(data=BMI, aes(xintercept=mean(bmi), color=sex),
             linetype="dashed") + 
  facet_grid(. ~ drug_use_freq) +
  labs(title = "density plot for BMI")

one.way = 
  aov (bmi~drug_use_freq, data = BMI)
summary(one.way)
```



## Logistic regression
```{r}

library(glmnet)

yrbss_state_tidy_glm <- 
  yrbss_state_tidy_additional %>% 
  mutate(drug_use = ifelse(drug_use_freq == "No Drug Use", 0, 1))

model_fit <- glm(drug_use ~ grade + sex + race4 + drunk_driving + drunk_driving : grade + drunk_driving : sex + drunk_driving : race4 + carrying_weapon + carrying_weapon : race4 + carrying_weapon : sex + + suicide_attempt + suicide_attempt : race4 + physical_fight + early_sex + binge_drinking + smoking_status + seat_belt + grades_school + sleeping_time + smoking_status:race4 + binge_drinking:race4 + seat_belt:race4 + 
    grades_school:race4 + grades_school:grade + smoke_age + alcohol_age, data = yrbss_state_tidy_glm)

step(model_fit, direction = "both")

model_fit_AIC <-  glm(formula = drug_use ~ grade + sex + race4 + drunk_driving + 
    carrying_weapon + suicide_attempt + physical_fight + early_sex + 
    binge_drinking + smoking_status + grades_school + sleeping_time + 
    smoke_age + alcohol_age + grade:drunk_driving + sex:drunk_driving + 
    race4:carrying_weapon, data = yrbss_state_tidy_glm)

step(model_fit, direction = "both", k = log(19854))

model_fit_BIC <- glm(formula = drug_use ~ grade + sex + race4 + suicide_attempt + 
    physical_fight + early_sex + smoking_status + binge_drinking + 
    grades_school + smoke_age + alcohol_age, data = yrbss_state_tidy_glm)

y <- yrbss_state_tidy_glm %>% pull(drug_use)
x <- model.matrix(drug_use ~ grade + sex + race4 + drunk_driving + drunk_driving : grade + drunk_driving : sex + drunk_driving : race4 + carrying_weapon + carrying_weapon : race4 + carrying_weapon : sex + + suicide_attempt + suicide_attempt : race4 + physical_fight + early_sex + binge_drinking + smoking_status + seat_belt + grades_school + sleeping_time + smoking_status:race4 + binge_drinking:race4 + seat_belt:race4 + 
    grades_school:race4 + grades_school:grade + smoke_age + alcohol_age, data = yrbss_state_tidy_glm)[, -1]
lambda = 10^(seq(3, -2, -0.1))

lasso_fit =
  glmnet(x, y, lambda = lambda_opt)

lasso_cv =
  cv.glmnet(x, y, lambda = lambda)

lambda_opt = lasso_cv$lambda.min

lasso_fit %>% 
  broom::tidy() %>% 
  complete(term, lambda, fill = list(estimate = 0)) %>% 
  filter(term != "(Intercept)") %>% 
  ggplot(aes(x = log(lambda), y = estimate, color = term)) +
  geom_line() +
  geom_vline(xintercept = log(lambda_opt))

model_fit_lasso <- glm(drug_use ~ grade + race4 + drunk_driving + suicide_attempt + physical_fight + early_sex + smoking_status + binge_drinking + grades_school + seat_belt + sleeping_time + race4:grades_school + smoke_age + alcohol_age, data = yrbss_state_tidy_glm)
```

Cross_Validation

```{r}
library(modelr)
cv_df <- crossv_mc(yrbss_state_tidy_glm, 100, id = "group_id") %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble)
  )

cv_results <- cv_df %>% mutate(
  model_fit_AIC = map(.x = train, ~glm(drug_use ~ grade + sex + race4 + drunk_driving + 
    carrying_weapon + suicide_attempt + physical_fight + early_sex + 
    binge_drinking + smoking_status + grades_school + sleeping_time + 
    smoke_age + alcohol_age + grade:drunk_driving + sex:drunk_driving + 
    race4:carrying_weapon, data = .x)),
  model_fit_BIC = map(.x = train, ~ glm(drug_use ~ grade + sex + race4 + suicide_attempt + 
    physical_fight + early_sex + smoking_status + binge_drinking + 
    grades_school + smoke_age + alcohol_age, data = .x)),
  model_fit_lasso = map(.x = train, ~glm(drug_use ~ grade + race4 + drunk_driving + suicide_attempt + physical_fight + early_sex + smoking_status + binge_drinking + grades_school + seat_belt + sleeping_time + race4:grades_school + smoke_age + alcohol_age, data = .x))
) %>% 
  mutate(
    rmse_AIC = map2_dbl(.x = model_fit_AIC, .y = test, ~rmse(model = .x, data = .y)),
    rmse_BIC = map2_dbl(.x = model_fit_BIC, .y = test, ~rmse(model = .x, data = .y)),
    rmse_lasso = map2_dbl(.x = model_fit_lasso, .y = test, ~rmse(model = .x, data = .y))
  )

cv_results %>% select(group_id, starts_with("rmse_")) %>% 
  pivot_longer(cols = rmse_AIC:rmse_lasso, names_to = "model_type", values_to = "rmse", names_prefix = "rmse_") %>% 
  ggplot(aes(x = rmse, fill = model_type)) +
  geom_density(alpha = 0.3)

```

