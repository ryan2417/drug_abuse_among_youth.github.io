---
title: "Data tidy"
output: github_document
---

```{r}
library(tidyverse)
library(survey)
library(viridis)
library(modelr)

knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE,
  include = FALSE
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d(option = "viridis")
scale_fill_discrete = scale_fill_viridis_d(option = "viridis")
```

```{r}
yrbss_state_a <- readRDS("data/2019 states a-m.rds")
yrbss_state_z <- readRDS("data/2019 states n-z.rds")
yrbss_state = rbind(yrbss_state_a,yrbss_state_z)
yrbss_state = as_tibble(yrbss_state)
```

### 01～03
```{r}
yrbss_state
```



### 05～07
```{r}
yrbss_state
```



### 09～11
```{r}

```



### 13～15
```{r}
yrbss_state
```



### 17～19
```{r}
yrbss_state
```

```{r}
drug_use_tidy <- function(input_list){
  output <- case_when(input_list == 1 ~ 0,
                      input_list == 2 ~ 1.5,
                      input_list == 3 ~ 6,
                      input_list == 4 ~ 14.5,
                      input_list == 5 ~ 29.5,
                      input_list > 5 ~ 40)
  return(output)
}
drug_use_frequency <- function(input_list){
  output <- case_when(input_list == 0 ~ "No Drug Use",
                      input_list > 0 & input_list < 40 ~ "Light Dose",
                      input_list >= 40 ~ "Heavy Dose")
  factor(output, levels = c("No Drug Use", "Light Dose", "Heavy Dose"))
}

age_tidy <- function(input_list) {
  output <- case_when(input_list == 1 ~ NA_real_,
                      input_list == 2 ~ 8,
                      input_list == 3 ~ 9.5,
                      input_list == 4 ~ 11.5,
                      input_list == 5 ~ 13.5,
                      input_list == 6 ~ 15.5,
                      input_list == 7 ~ 17.5)
}

```




```{r}
yrbss_state_tidy <-
  yrbss_state %>% 
  drop_na(q45, q46, q50, q51, q52, q53, q54, q55, q56) %>% 
  mutate(
    #age_initial_alcohol = age_tidy(q40),
    #age_initial_smoking = age_tidy(q31),
    #age_marijuana = age_tidy(q46),
    marijuana = drug_use_tidy(q45),
    cocaine = drug_use_tidy(q50),
    inhale = drug_use_tidy(q51),
    heroin = drug_use_tidy(q52),
    methamphetamine = drug_use_tidy(q53),
    ecstasy = drug_use_tidy(q54),
    steroid = drug_use_tidy(q55),
    illegal_injection = case_when(q56 == 1 ~ 0,
                                  q56 == 2 ~ 20,
                                  q56 == 3 ~ 40),
    drug_use_sum = rowSums(across(marijuana:illegal_injection)),
    other_drug_sum = rowSums(across(cocaine:illegal_injection)),
    drug_use_freq = drug_use_frequency(drug_use_sum),
    marijuana_use_freq = drug_use_frequency(marijuana),
    cocaine_use_freq = drug_use_frequency(cocaine),
    inhale_use_freq = drug_use_frequency(inhale),
    heroin_use_freq = drug_use_frequency(heroin),
    methamphetamine_use_freq = drug_use_frequency(methamphetamine),
    ecstasy_use_freq = drug_use_frequency(ecstasy),
    steroid_use_freq = drug_use_frequency(steroid),
    illegal_injection_use_freq = drug_use_frequency(illegal_injection)
    )
```







## Part 2

```{r}
crude_analysis <- function(input_df, input_name){
  totaln <- input_df %>% nrow()
  input_df %>% 
    group_by(drug_use_freq, across(input_name)) %>%
    count() %>%
    pivot_wider(values_from = n, names_from = starts_with(input_name), names_prefix = paste0(input_name,"_")) %>%
    ungroup() %>% 
    select(-drug_use_freq) %>% 
    chisq.test() %>% 
    broom::tidy() %>% 
    mutate(cramer_v_effect_size = sqrt(statistic / totaln*parameter)) %>% 
    select(statistic, p.value, df = parameter, cramer_v_effect_size)
}

grade_analysis <- function(input_df, input_name){
  input_df %>% 
    group_by(grade, drug_use_freq, across(all_of(input_name))) %>% 
    count() %>% 
    pivot_wider(values_from = n, names_from = starts_with(input_name), names_prefix = paste0(input_name,"_")) %>% 
    ungroup() %>% 
    select(-drug_use_freq) %>% 
    mutate(grade = ifelse(is.na(grade), "Missing", as.character(grade))) %>% 
    nest(data = starts_with(input_name)) %>% 
    mutate(
      chisq_tests = map(.x = data, ~chisq.test(x = .x)),
      chisq_result = map(chisq_tests, broom::tidy),
      totaln = map(data, colSums),
      totaln = map_dbl(.x = totaln, ~reduce(.x, sum))
      ) %>% 
    select(grade, chisq_result, totaln) %>% 
    unnest(chisq_result) %>% 
    mutate(cramer_v_effect_size = sqrt(statistic / totaln*parameter)) %>% 
    select(grade, statistic, p.value, df = parameter, cramer_v_effect_size)
}

gender_analysis <- function(input_df, input_name){
  input_df %>% 
    group_by(sex, drug_use_freq, across(all_of(input_name))) %>%
    count() %>% 
    pivot_wider(values_from = n, names_from = starts_with(input_name), 
                names_prefix = paste0(input_name,"_")) %>% 
    ungroup() %>% 
    select(-drug_use_freq) %>% 
    mutate(sex = ifelse(is.na(sex), "Missing", as.character(sex))) %>% 
    nest(data = starts_with(input_name)) %>% 
    mutate(
    chisq_tests = map(.x = data, ~chisq.test(x = .x)),
    chisq_result = map(chisq_tests, broom::tidy),
    totaln = map(data, colSums),
    totaln = map_dbl(.x = totaln, ~reduce(.x, sum))) %>% 
    select(sex, chisq_result, totaln) %>%
    unnest(chisq_result) %>% 
    mutate(cramer_v_effect_size = sqrt(statistic / totaln*parameter)) %>% 
    select(sex, statistic, p.value, df = parameter, cramer_v_effect_size)
}

race_analysis <- function(input_df, input_name){
  input_df %>% 
    group_by(race4, drug_use_freq, across(all_of(input_name))) %>%
    count() %>% 
    pivot_wider(values_from = n, names_from = starts_with(input_name), 
                names_prefix = paste0(input_name,"_")) %>% 
    ungroup() %>% 
    select(-drug_use_freq) %>% 
    mutate(race4 = ifelse(is.na(race4), "Missing", as.character(race4))) %>% 
    nest(data = starts_with(input_name)) %>% 
    mutate(
      chisq_tests = map(.x = data, ~chisq.test(x = .x)),
      chisq_result = map(chisq_tests, broom::tidy),
      totaln = map(.x = data, colSums),
      totaln = map_dbl(.x = totaln, ~reduce(.x, sum))
    ) %>% 
    select(race4, chisq_result, totaln) %>% 
    unnest(chisq_result) %>% 
    mutate(cramer_v_effect_size = sqrt(statistic / totaln*parameter)) %>% 
    select(race, statistic, p.value, df = parameter, cramer_v_effect_size)
}
```

### Drunk driving

```{r}
yrbss_state_tidy_drunk_driving <- 
  yrbss_state_tidy %>% 
  drop_na(q9, q10) %>% 
  mutate(
    drunk_driving = ifelse(q9 > 1 | q10 > 2, "Yes", "No")
  ) %>% 
  select(
    drunk_driving, drug_use_freq, grade, sex, race4
  )
```

Crude Analysis

```{r}
crude_analysis(yrbss_state_tidy_drunk_driving, "drunk_driving")

yrbss_state_tidy_drunk_driving %>% 
  group_by(drug_use_freq) %>% 
  summarize(
    prop_drunk_driving = sum(drunk_driving == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_drunk_driving)) +
  geom_bar(stat = "identity", position = "dodge")
```


Stratified Analysis over Grade

```{r}
grade_analysis(yrbss_state_tidy_drunk_driving, "drunk_driving")

yrbss_state_tidy_drunk_driving %>% 
  mutate(grade = ifelse(is.na(grade), "Missing", as.character(grade))) %>% 
  group_by(drug_use_freq, grade) %>% 
  summarize(
    prop_drunk_driving = sum(drunk_driving == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_drunk_driving, fill = grade)) +
  geom_bar(stat = "identity", position = "dodge")
```

Over Gender

```{r}
gender_analysis(yrbss_state_tidy_drunk_driving, "drunk_driving")

yrbss_state_tidy_drunk_driving %>% 
  mutate(sex = ifelse(is.na(sex), "Missing", as.character(sex))) %>% 
  group_by(drug_use_freq, sex) %>% 
  summarize(
    prop_drunk_driving = sum(drunk_driving == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_drunk_driving, fill = sex)) +
  geom_bar(stat = "identity", position = "dodge")
```

Over race
```{r}
race_analysis(yrbss_state_tidy_drunk_driving, "drunk_driving")

yrbss_state_tidy_drunk_driving %>% 
  mutate(race4 = ifelse(is.na(race4), "Missing", as.character(race4))) %>% 
  group_by(drug_use_freq, race4) %>% 
  summarize(
    prop_drunk_driving = sum(drunk_driving == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_drunk_driving, fill = race4)) +
  geom_bar(stat = "identity", position = "dodge")
```

**Marijuana vs Other Drug** 
```{r}
yrbss_state_tidy_3 <-
  yrbss_state_tidy %>% 
  
```

```{r}
yrbss_state_tidy %>% 
  drop_na(q9, q10) %>% 
  mutate(
    drug_usage = case_when(other_drug_sum == 0 & marijuana > 0 ~ "marijuana",
                                other_drug_sum > 0 & marijuana == 0 ~ "other drug",
                                other_drug_sum > 0 & marijuana > 0 ~ "Both drug",
                           other_drug_sum == 0 & marijuana == 0 ~ "No drug"),
    drunk_driving = ifelse(q9 > 1 | q10 > 2, "Yes", "No")
  ) %>% 
  filter(drug_usage %in% c("marijuana", "other drug")) %>% 
  group_by(drug_usage, drunk_driving) %>% 
  count() %>% 
  pivot_wider(values_from = n, names_from = drunk_driving, names_prefix = "drunk_driving_") %>% 
  ungroup() %>%
  select(-drug_usage) %>% 
  chisq.test()

yrbss_state_tidy %>% 
  filter(year == 2019) %>% 
  drop_na(q9, q10) %>% 
  mutate(
    drug_usage = case_when(other_drug_sum == 0 & marijuana > 0 ~ "marijuana",
                                other_drug_sum > 0 & marijuana == 0 ~ "other drug",
                                other_drug_sum > 0 & marijuana > 0 ~ "Both drug",
                           other_drug_sum == 0 & marijuana == 0 ~ "No drug"),
    drunk_driving = ifelse(q9 > 1 | q10 > 2, "Yes", "No")
  ) %>% 
  filter(drug_usage %in% c("marijuana", "other drug")) %>% 
  group_by(drug_usage) %>% 
  summarize(
    prop_drunk_driving = sum(drunk_driving == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_usage, y = prop_drunk_driving)) +
  geom_bar(stat = "identity")
```


### Carrying weapon

```{r}
yrbss_state_tidy_carrying_weapon <- yrbss_state_tidy %>%
  drop_na(q14) %>% 
  mutate(
    carrying_weapon = ifelse(q14 == 1, "No", "Yes")
  )
```


crude analysis

```{r}
crude_analysis(yrbss_state_tidy_carrying_weapon, "carrying_weapon")

yrbss_state_tidy_carrying_weapon %>% 
  group_by(drug_use_freq) %>% 
  summarize(
    prop_carrying_weapon = sum(carrying_weapon == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_carrying_weapon)) +
  geom_bar(stat = "identity", position = "dodge")
```

over grade
```{r}
grade_analysis(yrbss_state_tidy_carrying_weapon, "carrying_weapon")

yrbss_state_tidy_carrying_weapon %>% 
  mutate(grade = ifelse(is.na(grade), "Missing", as.character(grade))) %>% 
  group_by(drug_use_freq, grade) %>% 
  summarize(
    prop_carrying_weapon = sum(carrying_weapon == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_carrying_weapon, fill = grade)) +
  geom_bar(stat = "identity", position = "dodge")
```

over gender
```{r}
gender_analysis(yrbss_state_tidy_carrying_weapon, "carrying_weapon")

yrbss_state_tidy_carrying_weapon %>% 
  mutate(sex = ifelse(is.na(sex), "Missing", as.character(sex))) %>% 
  group_by(drug_use_freq, sex) %>% 
  summarize(
    prop_carrying_weapon = sum(carrying_weapon == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_carrying_weapon, fill = sex)) +
  geom_bar(stat = "identity", position = "dodge")
```

Over race
```{r}
race_analysis(yrbss_state_tidy_carrying_weapon, "carrying_weapon")
yrbss_state_tidy_carrying_weapon %>% 
  mutate(race4 = ifelse(is.na(race4), "Missing", as.character(race4))) %>% 
  group_by(drug_use_freq, race4) %>% 
  summarize(
    prop_carrying_weapon = sum(carrying_weapon == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_carrying_weapon, fill = race4)) +
  geom_bar(stat = "identity", position = "dodge")
```

```{r}
yrbss_state_tidy %>% 
  filter(year == 2019) %>% 
  drop_na(q14) %>% 
  mutate(
    carrying_weapon = ifelse(q14 == 1, "No", "Yes"),
    drug_usage = case_when(other_drug_sum == 0 & marijuana > 0 ~ "marijuana",
                                other_drug_sum > 0 & marijuana == 0 ~ "other drug",
                                other_drug_sum > 0 & marijuana > 0 ~ "Both drug",
                           other_drug_sum == 0 & marijuana == 0 ~ "No drug")
  ) %>% 
  filter(drug_usage %in% c("marijuana", "other drug")) %>% 
  group_by(drug_usage, carrying_weapon) %>% 
  count() %>% 
  pivot_wider(values_from = n, names_from = carrying_weapon, names_prefix = "carrying_weapon_") %>% 
  ungroup() %>%
  select(-drug_usage) %>% 
  chisq.test()

yrbss_state_tidy %>% 
  drop_na(q14) %>% 
  mutate(
    carrying_weapon = ifelse(q14 == 1, "No", "Yes"),
    drug_usage = case_when(other_drug_sum == 0 & marijuana > 0 ~ "marijuana",
                                other_drug_sum > 0 & marijuana == 0 ~ "other drug",
                                other_drug_sum > 0 & marijuana > 0 ~ "Both drug",
                           other_drug_sum == 0 & marijuana == 0 ~ "No drug")
  ) %>% 
  filter(drug_usage %in% c("marijuana", "other drug")) %>% 
  group_by(drug_usage) %>% 
  summarize(
    prop_carrying_weapon = sum(carrying_weapon == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_usage, y = prop_carrying_weapon)) +
  geom_bar(stat = "identity", position = "dodge")
```



### Suicide Attempt

```{r}
yrbss_state_tidy_suicide_attempt <- 
  yrbss_state_tidy %>%
  filter(year == 2019) %>% 
  drop_na(q26) %>% 
  mutate(
    suicide_attempt = ifelse(q26 == 1, "Yes", "No")
  )
```

crude

```{r}
crude_analysis(yrbss_state_tidy_suicide_attempt, "suicide_attempt")

yrbss_state_tidy_suicide_attempt %>%
  group_by(drug_use_freq) %>% 
  summarize(
    prop_suicide_attempt = sum(suicide_attempt == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_suicide_attempt)) +
  geom_bar(stat = "identity", position = "dodge")
```



Over Grade

```{r}
grade_analysis(yrbss_state_tidy_suicide_attempt, "suicide_attempt")

yrbss_state_tidy_suicide_attempt %>% 
  mutate(grade = ifelse(is.na(grade), "Missing", as.character(grade))) %>% 
  group_by(drug_use_freq, grade) %>% 
  summarize(
    prop_suicide_attempt = sum(suicide_attempt == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_suicide_attempt, fill = grade)) +
  geom_bar(stat = "identity", position = "dodge")
```

Over Gender 


```{r}
gender_analysis(yrbss_state_tidy_suicide_attempt, "suicide_attempt")

yrbss_state_tidy_suicide_attempt %>% 
  mutate(sex = ifelse(is.na(sex), "Missing", as.character(sex))) %>% 
  group_by(drug_use_freq, sex) %>% 
  summarize(
    prop_suicide_attempt = sum(suicide_attempt == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_suicide_attempt, fill = sex)) +
  geom_bar(stat = "identity", position = "dodge")
```

Over race

```{r}
race_analysis(yrbss_state_tidy_suicide_attempt, "suicide_attempt")

yrbss_state_tidy_suicide_attempt %>% 
  mutate(race4 = ifelse(is.na(race4), "Missing", as.character(race4))) %>% 
  group_by(drug_use_freq, race4) %>% 
  summarize(
    prop_suicide_attempt = sum(suicide_attempt == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_suicide_attempt, fill = race4)) +
  geom_bar(stat = "identity", position = "dodge")
```


```{r}
yrbss_state_tidy %>% 
  filter(year == 2019) %>% 
  drop_na(q26) %>% 
  mutate(
    suicide_attempt = ifelse(q26 == 1, "Yes", "No"),
    drug_usage = case_when(other_drug_sum == 0 & marijuana > 0 ~ "marijuana",
                                other_drug_sum > 0 & marijuana == 0 ~ "other drug",
                                other_drug_sum > 0 & marijuana > 0 ~ "Both drug",
                           other_drug_sum == 0 & marijuana == 0 ~ "No drug")
  ) %>% 
  filter(drug_usage %in% c("marijuana", "other drug")) %>% 
  group_by(drug_usage, suicide_attempt) %>% 
  count() %>% 
  pivot_wider(values_from = n, names_from = suicide_attempt, names_prefix = "suicide_attempt_") %>% 
  ungroup() %>%
  select(-drug_usage) %>% 
  chisq.test()

yrbss_state_tidy %>% 
  filter(year == 2019) %>% 
  drop_na(q26) %>% 
  mutate(
    suicide_attempt = ifelse(q26 == 1, "Yes", "No"),
    drug_usage = case_when(other_drug_sum == 0 & marijuana > 0 ~ "marijuana",
                                other_drug_sum > 0 & marijuana == 0 ~ "other drug",
                                other_drug_sum > 0 & marijuana > 0 ~ "Both drug",
                           other_drug_sum == 0 & marijuana == 0 ~ "No drug")
  ) %>% 
  filter(drug_usage %in% c("marijuana", "other drug")) %>% 
  group_by(drug_usage) %>% 
  summarize(
    prop_suicide_attempt = sum(suicide_attempt == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_usage, y = prop_suicide_attempt)) +
  geom_bar(stat = "identity", position = "dodge")
```

### Quit smoking

```{r}
yrbss_state_tidy_quit_smoke <- 
  yrbss_state_tidy %>%
  drop_na(q39) %>% 
  filter(q39 != 1) %>% 
  mutate(
    quit_smoke = case_when(q39 == 2 ~ "Yes",
                           q39 == 3 ~ "No")
  ) 
```

crude

```{r}
crude_analysis(yrbss_state_tidy_quit_smoke, "quit_smoke")

yrbss_state_tidy_quit_smoke %>%
  group_by(drug_use_freq) %>% 
  summarize(
    prop_quit_smoke = sum(quit_smoke == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_quit_smoke)) +
  geom_bar(stat = "identity", position = "dodge")

yrbss_state_tidy_quit_smoke %>%
  group_by(drug_use_freq, quit_smoke) %>% 
  count()
```



Over Grade

```{r}
grade_analysis(yrbss_state_tidy_quit_smoke, "quit_smoke")

yrbss_state_tidy_quit_smoke %>% 
  mutate(grade = ifelse(is.na(grade), "Missing", as.character(grade))) %>% 
  group_by(drug_use_freq, grade) %>% 
  summarize(
    prop_quit_smoke = sum(quit_smoke == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_quit_smoke, fill = grade)) +
  geom_bar(stat = "identity", position = "dodge")
```

Over Gender 

```{r}
gender_analysis(yrbss_state_tidy_quit_smoke, "quit_smoke")

yrbss_state_tidy_quit_smoke %>% 
  mutate(sex = ifelse(is.na(sex), "Missing", as.character(sex))) %>% 
  group_by(drug_use_freq, sex) %>% 
  summarize(
    prop_quit_smoke = sum(quit_smoke == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_quit_smoke, fill = sex)) +
  geom_bar(stat = "identity", position = "dodge")
```

Over race

```{r}
race_analysis(yrbss_state_tidy_quit_smoke, "quit_smoke")

yrbss_state_tidy_quit_smoke %>% 
  mutate(race4 = ifelse(is.na(race4), "Missing", as.character(race4))) %>% 
  group_by(drug_use_freq, race4) %>% 
  summarize(
    prop_quit_smoke = sum(quit_smoke == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_quit_smoke, fill = race4)) +
  geom_bar(stat = "identity", position = "dodge")
```



### physical fight

```{r}
yrbss_state_tidy_physical_fight <- 
  yrbss_state_tidy %>%
  drop_na(q17) %>% 
  mutate(
    physical_fight = ifelse(q17 == 1, "No", "Yes")
  ) 
```

crude

```{r}
crude_analysis(yrbss_state_tidy_physical_fight, "physical_fight")

yrbss_state_tidy_physical_fight %>%
  group_by(drug_use_freq) %>% 
  summarize(
    prop_physical_fight = sum(physical_fight == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_physical_fight)) +
  geom_bar(stat = "identity", position = "dodge")

yrbss_state_tidy_quit_smoke %>%
  group_by(drug_use_freq, physical_fight) %>% 
  count()
```



Over Grade

```{r}
grade_analysis(yrbss_state_tidy_physical_fight, "physical_fight")

yrbss_state_tidy_physical_fight %>% 
  mutate(grade = ifelse(is.na(grade), "Missing", as.character(grade))) %>% 
  group_by(drug_use_freq, grade) %>% 
  summarize(
    prop_physical_fight = sum(physical_fight == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_physical_fight, fill = grade)) +
  geom_bar(stat = "identity", position = "dodge")
```

Over Gender 

```{r}
gender_analysis(yrbss_state_tidy_physical_fight, "physical_fight")

yrbss_state_tidy_physical_fight %>% 
  mutate(sex = ifelse(is.na(sex), "Missing", as.character(sex))) %>% 
  group_by(drug_use_freq, sex) %>% 
  summarize(
    prop_physical_fight = sum(physical_fight == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_physical_fight, fill = sex)) +
  geom_bar(stat = "identity", position = "dodge")
```

Over race

```{r}
race_analysis(yrbss_state_tidy_physical_fight, "physical_fight")

yrbss_state_tidy_physical_fight %>% 
  mutate(race4 = ifelse(is.na(race4), "Missing", as.character(race4))) %>% 
  group_by(drug_use_freq, race4) %>% 
  summarize(
    prop_physical_fight = sum(physical_fight == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_physical_fight, fill = race4)) +
  geom_bar(stat = "identity", position = "dodge")
```


### Early-age Sexual Intercourse

```{r}
yrbss_state_tidy_early_sex <- 
  yrbss_state_tidy %>%
  drop_na(q59) %>% 
  mutate(
    early_sex = ifelse(q59 > 1 & q59 < 5 , "Yes", "No")
  ) 
```

crude

```{r}
crude_analysis(yrbss_state_tidy_early_sex, "early_sex")

yrbss_state_tidy_early_sex %>%
  group_by(drug_use_freq) %>% 
  summarize(
    prop_early_sex = sum(early_sex == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_early_sex)) +
  geom_bar(stat = "identity", position = "dodge")

yrbss_state_tidy_early_sex %>%
  group_by(drug_use_freq, early_sex) %>% 
  count()
```



Over Grade

```{r}
grade_analysis(yrbss_state_tidy_early_sex, "early_sex")

yrbss_state_tidy_early_sex %>% 
  mutate(grade = ifelse(is.na(grade), "Missing", as.character(grade))) %>% 
  group_by(drug_use_freq, grade) %>% 
  summarize(
    prop_early_sex = sum(early_sex == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_early_sex, fill = grade)) +
  geom_bar(stat = "identity", position = "dodge")
```

Over Gender 

```{r}
gender_analysis(yrbss_state_tidy_early_sex, "early_sex")

yrbss_state_tidy_early_sex %>% 
  mutate(sex = ifelse(is.na(sex), "Missing", as.character(sex))) %>% 
  group_by(drug_use_freq, sex) %>% 
  summarize(
    prop_early_sex = sum(early_sex == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_early_sex, fill = sex)) +
  geom_bar(stat = "identity", position = "dodge")
```

Over race

```{r}
race_analysis(yrbss_state_tidy_early_sex, "early_sex")

yrbss_state_tidy_early_sex %>% 
  mutate(race4 = ifelse(is.na(race4), "Missing", as.character(race4))) %>% 
  group_by(drug_use_freq, race4) %>% 
  summarize(
    prop_early_sex = sum(early_sex == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_early_sex, fill = race4)) +
  geom_bar(stat = "identity", position = "dodge")

```


### Screening Use

```{r}
yrbss_state_tidy_screening_use <- 
  yrbss_state_tidy %>%
  drop_na(q79, q80) %>% 
  mutate(
    q79 = as.numeric(q79),
    q80 = as.numeric(q80),
    tv_use = case_when(q79 == 1 ~ 0, 
                       q79 == 2 ~ 0.5,
                       q79 > 2 ~ q79 - 2),
    computer_use = q80 - 2,
    computer_use = case_when(q80 == 1 ~ 0, 
                       q80 == 2 ~ 0.5,
                       q80 > 2 ~ q80 - 2),
    screening_use = tv_use + computer_use
  )
yrbss_state_tidy_heavy_screening_use %>% 
  group_by(drug_use_freq, screening_use) %>% 
  count() %>% 
  group_by(drug_use_freq) %>% 
  mutate(
    total = sum(n)
  ) %>% 
  ggplot(aes(x = screening_use, y = n/total)) +
  geom_bar(stat = "identity") +
  geom_smooth(se = FALSE) +
  facet_grid(.~drug_use_freq) 
```

### Heavy Screening Use

`````{r}
yrbss_state_tidy_heavy_screening_use <- 
  yrbss_state_tidy_screening_use  %>%
  mutate(
    heavy_screening_use = ifelse(screening_use >= 5, "Yes", "No")
  )

```

crude

```{r}
crude_analysis(yrbss_state_tidy_heavy_screening_use, "heavy_screening_use")

yrbss_state_tidy_heavy_screening_use %>%
  group_by(drug_use_freq) %>% 
  summarize(
    prop_heavy_screening_use = sum(heavy_screening_use == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_heavy_screening_use)) +
  geom_bar(stat = "identity", position = "dodge")

yrbss_state_tidy_heavy_screening_use %>%
  group_by(drug_use_freq, heavy_screening_use) %>% 
  count()
```



Over Grade

```{r}
grade_analysis(yrbss_state_tidy_heavy_screening_use, "heavy_screening_use")

yrbss_state_tidy_heavy_screening_use %>% 
  mutate(grade = ifelse(is.na(grade), "Missing", as.character(grade))) %>% 
  group_by(drug_use_freq, grade) %>% 
  summarize(
    prop_heavy_screening_use = sum(heavy_screening_use == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_heavy_screening_use, fill = grade)) +
  geom_bar(stat = "identity", position = "dodge")
```

Over Gender 

```{r}
gender_analysis(yrbss_state_tidy_early_sex, "early_sex")

yrbss_state_tidy_early_sex %>% 
  mutate(sex = ifelse(is.na(sex), "Missing", as.character(sex))) %>% 
  group_by(drug_use_freq, sex) %>% 
  summarize(
    prop_early_sex = sum(early_sex == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_early_sex, fill = sex)) +
  geom_bar(stat = "identity", position = "dodge")
```

Over race

```{r}
race_analysis(yrbss_state_tidy_early_sex, "early_sex")

yrbss_state_tidy_early_sex %>% 
  mutate(race4 = ifelse(is.na(race4), "Missing", as.character(race4))) %>% 
  group_by(drug_use_freq, race4) %>% 
  summarize(
    prop_early_sex = sum(early_sex == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_early_sex, fill = race4)) +
  geom_bar(stat = "identity", position = "dodge")

```


