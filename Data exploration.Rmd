---
title: "Data Exploration"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r setup, include=FALSE}
library(tidyverse)
library(patchwork)
library(usmap)
library(hash)
library(plotly)
yrbss_state = 
  read_csv("data/yrbss_state_lite")%>%
  rename(state = sitecode)%>%
  mutate(state = recode(state,"AZB" = "AZ"))
drug_type_df = 
  yrbss_state %>%  #Mutate and using reasonable variable names.
  select(state,age,sex,race4,drug_use_sum:illegal_injection_use_freq) %>%
  rename(All_drug          = drug_use_freq,
         marijuana         = marijuana_use_freq,
         cocaine           = cocaine_use_freq,
         inhale            = inhale_use_freq,
         heroin            = heroin_use_freq,
         methamphetamine   = methamphetamine_use_freq,
         ecstasy           = ecstasy_use_freq,
         steroid           = steroid_use_freq,
         illegal_injection = illegal_injection_use_freq)
```


Before we start more detailed analysis, this is the step that helps us know better about the whole data set. In this step we want to know the drug use by high school students over the United State. We are going to figure out the drug use proportion of different type of drug in each state, as well as in each race and age.


# Drug use in the United States overview{.tabset}

- The plots below show the distribution of drug use proportion in The United States.  
- According to CDC's questionnaire, we define the individual who takes a drug more than 40 times as a "Heavy dose user", the individual who takes a drug more than once and less than 40 times as a "Light dose user", and the individual who never uses drugs as no drug user.  
- The plot below is the sum number of all kinds of drugs use, which contain marijuana, cocaine, inhale, heroin, ecstasy, steroid, and illegal_injection.  
- We can tell from the plot that the drug use proportion varies hugely among states and states. And it seems no geographical relationship between drug use proportion and states. Light drug use distribution and heavy drug use distribution do have a strong relationship.  
- You can find the distribution of each type of drug in this site " https://meanstudent.shinyapps.io/yrbss_overview_shinyapp/"  

```{r,message=FALSE}
drug_use_overview_df = 
  drug_type_df%>%
  select(-drug_use_sum,-other_drug_sum)%>%
  pivot_longer(All_drug:illegal_injection,
               names_to = "drug_type",
               values_to = "dose")%>%
  count(state,drug_type,dose)%>%
  group_by(state,drug_type)%>%
  summarize(n,dose,sum = sum(n))%>%
  mutate(proportion = n/sum)


color_dict = hash() #Def the color of the map
color_dict[["Heavy Dose"]] = "red"
color_dict[["Light Dose"]] = "orange"
color_dict[["No Drug Use"]] = "blue"

#---------------------------------------------- Heavy Dose
Heavy_dose_df = 
    drug_use_overview_df %>%
    filter(drug_type == "All_drug",dose == "Heavy Dose")

Heavy_dose_map =   plot_usmap(data = Heavy_dose_df,values = "proportion", color = color_dict[["Heavy Dose"]],labels = TRUE) + 
  scale_fill_continuous(
    low = "white", high = color_dict[["Heavy Dose"]], name = "Proportion", label = scales::comma
  ) + theme(legend.position = "right")

Heavy_dose_map = ggplotly(Heavy_dose_map)
#---------------------------------------------- Heavy Dose



#---------------------------------------------- Light Dose
Light_dose_df = 
    drug_use_overview_df %>%
    filter(drug_type == "All_drug",dose == "Light Dose")

Light_dose_map =   plot_usmap(data = Light_dose_df,values = "proportion", color = color_dict[["Light Dose"]],labels = TRUE) + 
  scale_fill_continuous(
    low = "white", high = color_dict[["Light Dose"]], name = "Proportion", label = scales::comma
  ) + theme(legend.position = "right")
Light_dose_map = ggplotly(Light_dose_map)
#---------------------------------------------- Light Dose



#---------------------------------------------- No Drug Use
No_dose_df = 
    drug_use_overview_df %>%
    filter(drug_type == "All_drug",dose == "No Drug Use")

No_dose_map =   plot_usmap(data = No_dose_df,values = "proportion", color = color_dict[["No Drug Use"]],labels = TRUE) + 
  scale_fill_continuous(
    low = "white", high = color_dict[["No Drug Use"]], name = "Proportion", label = scales::comma
  ) + theme(legend.position = "right")

No_dose_map = ggplotly(No_dose_map)
#---------------------------------------------- No Drug Use
```
## Heavy Drug Use Distribution
```{r}
Heavy_dose_map
```

## Light Drug Use Distribution
```{r}
Light_dose_map
```


## No Drug Use Distribution
```{r}
No_dose_map
```


# Rank of drug use{.tabset}
- As is shown in the bar plot, AZ state has the most proportion of taking drug both in heavy dose and light dose which is `r pull(drug_use_overview_df %>% filter(drug_type == "All_drug",dose == "Heavy Dose",state == "AZ"),proportion)` and `r pull(drug_use_overview_df %>% filter(drug_type == "All_drug",dose == "Light Dose",state == "AZ"),proportion)`, on the contrary UT state has the least proportion of people who take drug, the proportion of students who haven't took drug yet is: `r pull(drug_use_overview_df %>% filter(drug_type == "All_drug",dose == "No Drug Use",state == "UT"),proportion)`.
```{r, message = FALSE}
#---------------------------------------------- No Drug Use
No_drug_state_count = 
  drug_use_overview_df %>%
  filter(drug_type == "All_drug",dose == "No Drug Use")%>%
  ggplot(aes(x = fct_reorder(state,proportion,.desc = TRUE), y = proportion))+
  geom_col()+
  xlab("state")+
  coord_flip()
#---------------------------------------------- No Drug Use


#---------------------------------------------- Heavy Drug Use
Heavy_drug_state_count =
  drug_use_overview_df %>%
  filter(drug_type == "All_drug",dose == "Heavy Dose")%>%
  ggplot(aes(x = fct_reorder(state,proportion,.desc = TRUE), y = proportion))+
  geom_col()+
  xlab("state")+
  coord_flip()
#---------------------------------------------- Heavy Drug Use


#---------------------------------------------- Light Drug Use
Light_drug_state_count = 
  drug_use_overview_df %>%
  filter(drug_type == "All_drug",dose == "Light Dose")%>%
  ggplot(aes(x = fct_reorder(state,proportion,.desc = TRUE), y = proportion))+
  geom_col()+
  xlab("state")+
  coord_flip()
#---------------------------------------------- Light Drug Use
```

## Heavy Drug Rank
```{r}
ggplotly(Heavy_drug_state_count)
```

## Light Drug Rank
```{r}
ggplotly(Light_drug_state_count)
```
## No Drug Rank
```{r}
ggplotly(No_drug_state_count)
```
# Drug type exploration

- Now we have a basic intuition of drug use in the United States. Now let's see how these eight kind of drugs are different from others. 
```{r, message=FALSE}
heavy_count = 
  drug_type_df%>%
  select(-drug_use_sum,-other_drug_sum,-sex)%>%
  mutate(race4 = as.factor(race4))%>%
  pivot_longer(All_drug:illegal_injection,
               names_to = "drug_type",
               values_to = "dose")%>%
  filter(drug_type != "All_drug")%>%
  group_by(drug_type,dose)%>%
  summarise(numbers = n())%>%
  filter(dose == "Heavy Dose")%>%
  ggplot(aes(x = fct_reorder(drug_type,numbers,.desc = TRUE),y = numbers))+
  geom_col()+
  coord_flip()+
  labs(title = "Heavy drug use")+
  xlab("")

lite_count = 
  drug_type_df%>%
  select(-drug_use_sum,-other_drug_sum,-sex)%>%
  mutate(race4 = as.factor(race4))%>%
  pivot_longer(All_drug:illegal_injection,
               names_to = "drug_type",
               values_to = "dose")%>%
  filter(drug_type != "All_drug")%>%
  group_by(drug_type,dose)%>%
  summarise(numbers = n())%>%
  filter(dose == "Light Dose")%>%
  ggplot(aes(x = fct_reorder(drug_type,numbers,.desc = TRUE),y = numbers))+
  geom_col()+
  coord_flip()+
  labs(title = "Light drug use")+
  xlab("")

Drug_use_count = heavy_count + lite_count
Drug_use_count
```

- We can tell that marijuana is the most popular drug over all drugs and the number of marijuana users are even more than the sum of other drugs' users.

```{r,message = FALSE}
drug_type_df%>%
  select(-drug_use_sum,-other_drug_sum,-sex)%>%
  mutate(race4 = as.factor(race4))%>%
  pivot_longer(All_drug:illegal_injection,
               names_to = "drug_type",
               values_to = "dose")%>%
  filter(drug_type != "All_drug",dose != "No Drug")%>%
  group_by(drug_type,dose)%>%
  summarise(numbers = n())%>%
  filter(dose != "No Drug Use")%>%
  pivot_wider(drug_type:dose,names_from = dose,values_from = numbers)%>%
  janitor::clean_names()%>%
  mutate(ratio = heavy_dose/light_dose)%>%
  ggplot(aes(x = fct_reorder(drug_type,ratio),y = ratio))+
  geom_col()+
  xlab("Drug type")+
  ggtitle("Heavy dose/Light Dose")
```

- Still we can find another useful information. Plot above is the ratio of heavy drug users and light drug users of each type of drug. A drug type with higher ratio value means individual who take this drug is more likely transfer into a heavy drug user.  
- This ratio not simply stand for addiction. Other properties like properties drugs' price, rarity... also can influence the ratio.

# Drug proportion in each states.{.tabset}

- First we find the Top 3 most commonly used drugs, which are marijuana, inhale and ecstasy and see their difference in each state and race.
- Again you can see the plot of all drugs in the following site:"https://meanstudent.shinyapps.io/yrbss_overview_shinyapp/"

```{r,message = FALSE}
drug_type_df%>%
  select(-drug_use_sum,-other_drug_sum,-sex)%>%
  mutate(race4 = as.factor(race4))%>%
  pivot_longer(All_drug:illegal_injection,
               names_to = "drug_type",
               values_to = "dose")%>%
  filter(drug_type != "All_drug",dose != "No Drug")%>%
  group_by(drug_type,dose)%>%
  summarise(numbers = n())%>%
  filter(dose != "No Drug Use")%>%
  pivot_wider(drug_type:dose,names_from = dose,values_from = numbers)%>%
  janitor::clean_names()%>%
  mutate(sum = heavy_dose+light_dose)%>%
  arrange(sum)%>%
  tail(3)%>%
  knitr::kable()
```


```{r, message = FALSE}
drug_state_race_df = #Mutate the race to their names
  drug_type_df%>%
  select(-drug_use_sum,-other_drug_sum,-sex)%>%
  mutate(race4 = case_when(
    race4==1 ~ "White",
    race4==2 ~ "Black",
    race4==3 ~ "Hispanic/Latino",
    race4==4 ~ "All Other Races",
  ))%>%
  mutate(race4 = as.factor(race4))%>%
  pivot_longer(All_drug:illegal_injection,
               names_to = "drug_type",
               values_to = "dose")%>%
  count(state,race4,drug_type,dose)%>%
  group_by(state,race4,drug_type)%>%
  mutate(sum = sum(n),proportion = n/sum)%>%
  select(state,race4,drug_type,dose,proportion)
Drug_sum = drug_state_race_df%>%
    filter(drug_type == "All_drug")%>%
    ggplot(aes(x = state,y = proportion,color = dose))+
    scale_color_manual(values= c("#FF3225","#F5D247","#4728FA"))+
    geom_col()+
    facet_wrap(~race4)+
    coord_flip()
Marijuana = drug_state_race_df%>%
    filter(drug_type == "marijuana")%>%
    ggplot(aes(x = state,y = proportion,color = dose))+
    scale_color_manual(values= c("#FF3225","#F5D247","#4728FA"))+
    geom_col()+
    facet_wrap(~race4)+
    coord_flip()
Ecstasy = drug_state_race_df%>%
    filter(drug_type == "ecstasy")%>%
    ggplot(aes(x = fct_reorder(state,proportion),y = proportion,color = dose))+
    scale_color_manual(values= c("#FF3225","#F5D247","#4728FA"))+
    geom_col()+
    facet_wrap(~race4)+
    coord_flip()
Inhale = drug_state_race_df%>%
    filter(drug_type == "inhale")%>%
    ggplot(aes(x = fct_reorder(state,proportion),y = proportion,color = dose))+
    scale_color_manual(values= c("#FF3225","#F5D247","#4728FA"))+
    geom_col()+
    facet_wrap(~race4)+
    coord_flip()
```

- Form the follwing plots we can tell that

## All_drug
```{r}
ggplotly(Drug_sum)
```

## Marijuana
```{r}
ggplotly(Marijuana)
```

## Ecstasy
```{r}
ggplotly(Ecstasy)
```

## Inhale
```{r}
ggplotly(Inhale)
```




