---
title: "Data tidy"
output: github_document
---

```{r}
library(tidyverse)
library(survey)
library(viridis)
library(modelr)
library(plotly)
library(usmap)

knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE,
  include = FALSE
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d(option = "viridis")
scale_fill_discrete = scale_fill_viridis_d(option = "viridis")
```

```{r}
yrbss_state_a <- readRDS("data/2019 states a-m.rds")
yrbss_state_z <- readRDS("data/2019 states n-z.rds")
yrbss_state = rbind(yrbss_state_a,yrbss_state_z)
yrbss_state = as_tibble(yrbss_state)
```

### 01～03
```{r}
yrbss_state
```



### 05～07
```{r}
yrbss_state
```



### 09～11
```{r}
yrbss_state
```



### 13～15
```{r}
yrbss_state
```



### 17～19
```{r}
yrbss_state
```

```{r}
drug_use_tidy <- function(input_list){
  output <- case_when(input_list == 1 ~ 0,
                      input_list == 2 ~ 1.5,
                      input_list == 3 ~ 6,
                      input_list == 4 ~ 14.5,
                      input_list == 5 ~ 29.5,
                      input_list > 5 ~ 40)
  return(output)
}
drug_use_frequency <- function(input_list){
  output <- case_when(input_list == 0 ~ "No Drug Use",
                      input_list > 0 & input_list < 40 ~ "Light Dose",
                      input_list >= 40 ~ "Heavy Dose")
  factor(output, levels = c("No Drug Use", "Light Dose", "Heavy Dose"))
}

age_tidy <- function(input_list) {
  output <- case_when(input_list == 1 ~ NA_real_,
                      input_list == 2 ~ 8,
                      input_list == 3 ~ 9.5,
                      input_list == 4 ~ 11.5,
                      input_list == 5 ~ 13.5,
                      input_list == 6 ~ 15.5,
                      input_list == 7 ~ 17.5)
}

if_use = function(input_list){
  output = case_when(input_list == 0 ~ FALSE,
                     input_list != 0 ~ TRUE)
}

```

 
## Part 1

```{r}
yrbss_state_tidy <-
  yrbss_state %>% 
  drop_na(q45, q46, q50, q51, q52, q53, q54, q55, q56) %>% 
  mutate(
    grade = fct_recode(factor(grade, ordered = TRUE), 
                       "9th Grade" = "1",
                       "10th Grade" = "2",
                       "11th Grade" = "3",
                       "12th Grade" = "4"),
    grade = fct_explicit_na(grade, "Missing Grade"),
    sex = fct_recode(factor(sex, ordered = TRUE), 
                       "female" = "1",
                       "male" = "2"),
    sex = fct_explicit_na(sex, "Missing Gender"),
    race4 = fct_recode(factor(race4), 
                       "White" = "1",
                       "Black or African American" = "2",
                       "Hispanic/Latino" = "3",
                       "All other Races" = "4"),
    race4 = fct_explicit_na(race4, "Missing Race"),
    age_initial_alcohol = age_tidy(q40),
    age_initial_smoking = age_tidy(q31),
    age_marijuana = age_tidy(q46),
    marijuana = drug_use_tidy(q45),
    cocaine = drug_use_tidy(q50),
    inhale = drug_use_tidy(q51),
    heroin = drug_use_tidy(q52),
    methamphetamine = drug_use_tidy(q53),
    ecstasy = drug_use_tidy(q54),
    steroid = drug_use_tidy(q55),
    illegal_injection = case_when(q56 == 1 ~ 0,
                                  q56 == 2 ~ 20,
                                  q56 == 3 ~ 40),
    drug_use_sum = rowSums(across(marijuana:illegal_injection)),
    other_drug_sum = rowSums(across(cocaine:illegal_injection)),
    drug_use_freq = drug_use_frequency(drug_use_sum),
    marijuana_use_freq = drug_use_frequency(marijuana),
    cocaine_use_freq = drug_use_frequency(cocaine),
    inhale_use_freq = drug_use_frequency(inhale),
    heroin_use_freq = drug_use_frequency(heroin),
    methamphetamine_use_freq = drug_use_frequency(methamphetamine),
    ecstasy_use_freq = drug_use_frequency(ecstasy),
    steroid_use_freq = drug_use_frequency(steroid),
    illegal_injection_use_freq = drug_use_frequency(illegal_injection)
    )
```

### (3) State + Proportion + drug type (side by side bar chart)

```{r}
state_proportion_drugtype = yrbss_state_tidy %>% 
  select(sitename, marijuana, cocaine, inhale, heroin, methamphetamine, ecstasy, steroid, illegal_injection) %>% 
  mutate(marijuana = if_use(marijuana),
         others = cocaine + inhale + heroin + methamphetamine + 
           ecstasy + steroid + illegal_injection,
         others = if_use(others)) %>% 
  select(sitename, marijuana, others) %>% 
  group_by(sitename) %>% 
  summarise(total_population = n(),
            marijuana = sum(marijuana),
            others = sum(others)) %>% 
  mutate(proportion_marijuana = marijuana / total_population,
         proportion_others = others / total_population,
         total_proportion = proportion_marijuana + proportion_others) %>% 
  pivot_longer(proportion_marijuana:proportion_others,
               names_to = "drug_type",
               values_to = "proportion") %>% 
  mutate(drug_type = recode(drug_type, 
                            proportion_marijuana = "marijuana",
                            proportion_others = "other drugs"))
  

state_proportion_plot = ggplot(state_proportion_drugtype, 
                               aes(x = sitename, y = proportion, 
                                   fill = drug_type)) + 
  geom_bar(stat = "identity", position = 'dodge') +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) + 
  labs(x = "State", 
       y = "Drug Use Porportion",
       title = "Side-by-side Bar Plot of Porportion of Drug Use for Marijuana 
       and Other Drug Type")

ggplotly(state_proportion_plot)
```


### (4) State + marijuana start date map

```{r warning = FALSE}
state_age = yrbss_state_tidy %>% 
  select(sitename, age_marijuana) %>% 
  separate(sitename, "region", sep = "\\(") %>% 
  separate(region, "state", sep = " ") %>% 
  group_by(state) %>% 
  summarise(mean_start_age = mean(age_marijuana, na.rm = TRUE))

state_age_plot = plot_usmap(data = state_age, values = "mean_start_age", 
                            color = "red") + 
  scale_fill_gradient(low = "white", high = "red", 
                      name = "Mean Marijuana Start Age", label = scales::comma) + 
  theme(legend.position = "right")

ggplotly(state_age_plot)
```



## Part 2


### chi-square analysis function

```{r}
association_analysis <- function(input_df, input_name, type){
  if (type == "crude") {
    totaln <- input_df %>% nrow()
    output <- 
      input_df %>% 
      group_by(drug_use_freq, across(input_name)) %>%
      count() %>%
      pivot_wider(values_from = n, names_from = starts_with(input_name)) %>%
      ungroup() %>% 
      select(-drug_use_freq) %>% 
      chisq.test() %>% 
      broom::tidy() %>% 
      mutate(cramer_v_effect_size = sqrt(statistic / totaln*parameter),
             stratum = "Overall") %>% 
      select(stratum, statistic, p.value, df = parameter, cramer_v_effect_size)
  } else {
    output <- 
      input_df %>% 
      group_by(across(all_of(type)), drug_use_freq, across(all_of(input_name))) %>%
      count() %>% 
      pivot_wider(values_from = n, names_from = starts_with(input_name), names_prefix = input_name) %>% 
      ungroup() %>% 
      select(-drug_use_freq) %>% 
      nest(data = starts_with(input_name)) %>% 
      mutate(
      chisq_tests = map(.x = data, ~chisq.test(x = .x)),
      chisq_result = map(chisq_tests, broom::tidy),
      totaln = map(data, colSums),
      totaln = map_dbl(.x = totaln, ~reduce(.x, sum))) %>% 
      unnest(chisq_result) %>% 
      mutate(cramer_v_effect_size = sqrt(statistic / totaln*parameter)) %>% 
      select(stratum = starts_with(type), 
             statistic, p.value, 
             df = parameter, 
             cramer_v_effect_size)
  }
  return(output)
}

test_of_association <- function(input_df, input_name){
  output <- tibble(
    type = c("crude", "grade", "sex", "race4")
  )
  output %>% 
    mutate(results = map(.x = type, ~association_analysis(input_df, input_name, type = .x))) %>% 
    unnest(results) %>% 
    select(-type)
}

<<<<<<< HEAD
race_analysis <- function(input_df, input_name){
  input_df %>% 
    group_by(race4, drug_use_freq, across(all_of(input_name))) %>%
    count() %>% 
    pivot_wider(values_from = n, names_from = starts_with(input_name), 
                names_prefix = paste0(input_name,"_")) %>% 
    ungroup() %>% 
    select(-drug_use_freq) %>% 
    mutate(race4 = ifelse(is.na(race4), "Missing", as.character(race4))) %>% 
    nest(data = starts_with(input_name)) %>% 
    mutate(
      chisq_tests = map(.x = data, ~chisq.test(x = .x)),
      chisq_result = map(chisq_tests, broom::tidy),
      totaln = map(.x = data, colSums),
      totaln = map_dbl(.x = totaln, ~reduce(.x, sum))
    ) %>% 
    select(race4, chisq_result, totaln) %>% 
    unnest(chisq_result) %>% 
    mutate(cramer_v_effect_size = sqrt(statistic / totaln*parameter)) %>% 
    select(race4, statistic, p.value, df = parameter, cramer_v_effect_size)
}
=======
>>>>>>> d5c2ce5939c25c44c907f7fac6a83b9d89e1dfa7
```


### Drunk driving

```{r}
yrbss_state_tidy_drunk_driving <- 
  yrbss_state_tidy %>% 
  drop_na(q9, q10) %>% 
  mutate(
    drunk_driving = ifelse(q9 > 1 | q10 > 2, "Yes", "No")
  ) %>% 
  select(
    drunk_driving, drug_use_freq, grade, sex, race4
  )
```

association analysis

```{r}
crude_analysis(yrbss_state_tidy_drunk_driving, "drunk_driving")

test_of_association(yrbss_state_tidy_drunk_driving, "drunk_driving")

yrbss_state_tidy_drunk_driving %>% 
  group_by(drug_use_freq) %>% 
  summarize(
    prop_drunk_driving = sum(drunk_driving == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_drunk_driving)) +
  geom_bar(stat = "identity", position = "dodge")

yrbss_state_tidy_drunk_driving %>% 
  mutate(grade = ifelse(is.na(grade), "Missing", as.character(grade))) %>% 
  group_by(drug_use_freq, grade) %>% 
  summarize(
    prop_drunk_driving = sum(drunk_driving == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_drunk_driving, fill = grade)) +
  geom_bar(stat = "identity", position = "dodge")

yrbss_state_tidy_drunk_driving %>% 
  mutate(sex = ifelse(is.na(sex), "Missing", as.character(sex))) %>% 
  group_by(drug_use_freq, sex) %>% 
  summarize(
    prop_drunk_driving = sum(drunk_driving == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_drunk_driving, fill = sex)) +
  geom_bar(stat = "identity", position = "dodge")

yrbss_state_tidy_drunk_driving %>% 
  mutate(race4 = ifelse(is.na(race4), "Missing", as.character(race4))) %>% 
  group_by(drug_use_freq, race4) %>% 
  summarize(
    prop_drunk_driving = sum(drunk_driving == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_drunk_driving, fill = race4)) +
  geom_bar(stat = "identity", position = "dodge")
```


#### Marijuana vs Other Drug 
```{r}
yrbss_state_tidy_3 <-
  yrbss_state_tidy %>% 
  
```

```{r}
yrbss_state_tidy %>% 
  drop_na(q9, q10) %>% 
  mutate(
    drug_usage = case_when(other_drug_sum == 0 & marijuana > 0 ~ "marijuana",
                                other_drug_sum > 0 & marijuana == 0 ~ "other drug",
                                other_drug_sum > 0 & marijuana > 0 ~ "Both drug",
                           other_drug_sum == 0 & marijuana == 0 ~ "No drug"),
    drunk_driving = ifelse(q9 > 1 | q10 > 2, "Yes", "No")
  ) %>% 
  filter(drug_usage %in% c("marijuana", "other drug")) %>% 
  group_by(drug_usage, drunk_driving) %>% 
  count() %>% 
  pivot_wider(values_from = n, names_from = drunk_driving, names_prefix = "drunk_driving_") %>% 
  ungroup() %>%
  select(-drug_usage) %>% 
  chisq.test()

yrbss_state_tidy %>% 
  filter(year == 2019) %>% 
  drop_na(q9, q10) %>% 
  mutate(
    drug_usage = case_when(other_drug_sum == 0 & marijuana > 0 ~ "marijuana",
                                other_drug_sum > 0 & marijuana == 0 ~ "other drug",
                                other_drug_sum > 0 & marijuana > 0 ~ "Both drug",
                           other_drug_sum == 0 & marijuana == 0 ~ "No drug"),
    drunk_driving = ifelse(q9 > 1 | q10 > 2, "Yes", "No")
  ) %>% 
  filter(drug_usage %in% c("marijuana", "other drug")) %>% 
  group_by(drug_usage) %>% 
  summarize(
    prop_drunk_driving = sum(drunk_driving == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_usage, y = prop_drunk_driving)) +
  geom_bar(stat = "identity")
```


### Carrying weapon

```{r}
yrbss_state_tidy_carrying_weapon <- yrbss_state_tidy %>%
  drop_na(q14) %>% 
  mutate(
    carrying_weapon = ifelse(q14 == 1, "No", "Yes")
  )
```


```{r}
test_of_association(yrbss_state_tidy_carrying_weapon, "carrying_weapon")

yrbss_state_tidy_carrying_weapon %>% 
  group_by(drug_use_freq) %>% 
  summarize(
    prop_carrying_weapon = sum(carrying_weapon == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_carrying_weapon)) +
  geom_bar(stat = "identity", position = "dodge")

yrbss_state_tidy_carrying_weapon %>% 
  mutate(grade = ifelse(is.na(grade), "Missing", as.character(grade))) %>% 
  group_by(drug_use_freq, grade) %>% 
  summarize(
    prop_carrying_weapon = sum(carrying_weapon == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_carrying_weapon, fill = grade)) +
  geom_bar(stat = "identity", position = "dodge")

yrbss_state_tidy_carrying_weapon %>% 
  mutate(sex = ifelse(is.na(sex), "Missing", as.character(sex))) %>% 
  group_by(drug_use_freq, sex) %>% 
  summarize(
    prop_carrying_weapon = sum(carrying_weapon == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_carrying_weapon, fill = sex)) +
  geom_bar(stat = "identity", position = "dodge")

yrbss_state_tidy_carrying_weapon %>% 
  mutate(race4 = ifelse(is.na(race4), "Missing", as.character(race4))) %>% 
  group_by(drug_use_freq, race4) %>% 
  summarize(
    prop_carrying_weapon = sum(carrying_weapon == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_carrying_weapon, fill = race4)) +
  geom_bar(stat = "identity", position = "dodge")
```

```{r}
yrbss_state_tidy %>% 
  filter(year == 2019) %>% 
  drop_na(q14) %>% 
  mutate(
    carrying_weapon = ifelse(q14 == 1, "No", "Yes"),
    drug_usage = case_when(other_drug_sum == 0 & marijuana > 0 ~ "marijuana",
                                other_drug_sum > 0 & marijuana == 0 ~ "other drug",
                                other_drug_sum > 0 & marijuana > 0 ~ "Both drug",
                           other_drug_sum == 0 & marijuana == 0 ~ "No drug")
  ) %>% 
  filter(drug_usage %in% c("marijuana", "other drug")) %>% 
  group_by(drug_usage, carrying_weapon) %>% 
  count() %>% 
  pivot_wider(values_from = n, names_from = carrying_weapon, names_prefix = "carrying_weapon_") %>% 
  ungroup() %>%
  select(-drug_usage) %>% 
  chisq.test()

yrbss_state_tidy %>% 
  drop_na(q14) %>% 
  mutate(
    carrying_weapon = ifelse(q14 == 1, "No", "Yes"),
    drug_usage = case_when(other_drug_sum == 0 & marijuana > 0 ~ "marijuana",
                                other_drug_sum > 0 & marijuana == 0 ~ "other drug",
                                other_drug_sum > 0 & marijuana > 0 ~ "Both drug",
                           other_drug_sum == 0 & marijuana == 0 ~ "No drug")
  ) %>% 
  filter(drug_usage %in% c("marijuana", "other drug")) %>% 
  group_by(drug_usage) %>% 
  summarize(
    prop_carrying_weapon = sum(carrying_weapon == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_usage, y = prop_carrying_weapon)) +
  geom_bar(stat = "identity", position = "dodge")
```



### Suicide Attempt

```{r}
yrbss_state_tidy_suicide_attempt <- 
  yrbss_state_tidy %>%
  filter(year == 2019) %>% 
  drop_na(q26) %>% 
  mutate(
    suicide_attempt = ifelse(q26 == 1, "Yes", "No")
  )
```


```{r}
test_of_association(yrbss_state_tidy_suicide_attempt, "suicide_attempt")

yrbss_state_tidy_suicide_attempt %>%
  group_by(drug_use_freq) %>% 
  summarize(
    prop_suicide_attempt = sum(suicide_attempt == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_suicide_attempt)) +
  geom_bar(stat = "identity", position = "dodge")

yrbss_state_tidy_suicide_attempt %>% 
  mutate(grade = ifelse(is.na(grade), "Missing", as.character(grade))) %>% 
  group_by(drug_use_freq, grade) %>% 
  summarize(
    prop_suicide_attempt = sum(suicide_attempt == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_suicide_attempt, fill = grade)) +
  geom_bar(stat = "identity", position = "dodge")

yrbss_state_tidy_suicide_attempt %>% 
  mutate(sex = ifelse(is.na(sex), "Missing", as.character(sex))) %>% 
  group_by(drug_use_freq, sex) %>% 
  summarize(
    prop_suicide_attempt = sum(suicide_attempt == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_suicide_attempt, fill = sex)) +
  geom_bar(stat = "identity", position = "dodge")

yrbss_state_tidy_suicide_attempt %>% 
  mutate(race4 = ifelse(is.na(race4), "Missing", as.character(race4))) %>% 
  group_by(drug_use_freq, race4) %>% 
  summarize(
    prop_suicide_attempt = sum(suicide_attempt == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_suicide_attempt, fill = race4)) +
  geom_bar(stat = "identity", position = "dodge")
```


```{r}
yrbss_state_tidy %>% 
  filter(year == 2019) %>% 
  drop_na(q26) %>% 
  mutate(
    suicide_attempt = ifelse(q26 == 1, "Yes", "No"),
    drug_usage = case_when(other_drug_sum == 0 & marijuana > 0 ~ "marijuana",
                                other_drug_sum > 0 & marijuana == 0 ~ "other drug",
                                other_drug_sum > 0 & marijuana > 0 ~ "Both drug",
                           other_drug_sum == 0 & marijuana == 0 ~ "No drug")
  ) %>% 
  filter(drug_usage %in% c("marijuana", "other drug")) %>% 
  group_by(drug_usage, suicide_attempt) %>% 
  count() %>% 
  pivot_wider(values_from = n, names_from = suicide_attempt, names_prefix = "suicide_attempt_") %>% 
  ungroup() %>%
  select(-drug_usage) %>% 
  chisq.test()

yrbss_state_tidy %>% 
  filter(year == 2019) %>% 
  drop_na(q26) %>% 
  mutate(
    suicide_attempt = ifelse(q26 == 1, "Yes", "No"),
    drug_usage = case_when(other_drug_sum == 0 & marijuana > 0 ~ "marijuana",
                                other_drug_sum > 0 & marijuana == 0 ~ "other drug",
                                other_drug_sum > 0 & marijuana > 0 ~ "Both drug",
                           other_drug_sum == 0 & marijuana == 0 ~ "No drug")
  ) %>% 
  filter(drug_usage %in% c("marijuana", "other drug")) %>% 
  group_by(drug_usage) %>% 
  summarize(
    prop_suicide_attempt = sum(suicide_attempt == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_usage, y = prop_suicide_attempt)) +
  geom_bar(stat = "identity", position = "dodge")
```

### Quit smoking

```{r}
yrbss_state_tidy_quit_smoke <- 
  yrbss_state_tidy %>%
  drop_na(q39) %>% 
  filter(q39 != 1) %>% 
  mutate(
    quit_smoke = case_when(q39 == 2 ~ "Yes",
                           q39 == 3 ~ "No")
  )
```



```{r}
test_of_association(yrbss_state_tidy_quit_smoke, "quit_smoke")

yrbss_state_tidy_quit_smoke %>%
  group_by(drug_use_freq) %>% 
  summarize(
    prop_quit_smoke = sum(quit_smoke == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_quit_smoke)) +
  geom_bar(stat = "identity", position = "dodge")

yrbss_state_tidy_quit_smoke %>% 
  mutate(grade = ifelse(is.na(grade), "Missing", as.character(grade))) %>% 
  group_by(drug_use_freq, grade) %>% 
  summarize(
    prop_quit_smoke = sum(quit_smoke == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_quit_smoke, fill = grade)) +
  geom_bar(stat = "identity", position = "dodge")

yrbss_state_tidy_quit_smoke %>% 
  mutate(sex = ifelse(is.na(sex), "Missing", as.character(sex))) %>% 
  group_by(drug_use_freq, sex) %>% 
  summarize(
    prop_quit_smoke = sum(quit_smoke == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_quit_smoke, fill = sex)) +
  geom_bar(stat = "identity", position = "dodge")

race_analysis(yrbss_state_tidy_quit_smoke, "quit_smoke")

yrbss_state_tidy_quit_smoke %>% 
  mutate(race4 = ifelse(is.na(race4), "Missing", as.character(race4))) %>% 
  group_by(drug_use_freq, race4) %>% 
  summarize(
    prop_quit_smoke = sum(quit_smoke == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_quit_smoke, fill = race4)) +
  geom_bar(stat = "identity", position = "dodge")
```



### physical fight

```{r}
yrbss_state_tidy_physical_fight <- 
  yrbss_state_tidy %>%
  drop_na(q17) %>% 
  mutate(
    physical_fight = ifelse(q17 == 1, "No", "Yes")
  )
```



```{r}
test_of_association(yrbss_state_tidy_physical_fight, "physical_fight")

yrbss_state_tidy_physical_fight %>%
  group_by(drug_use_freq) %>% 
  summarize(
    prop_physical_fight = sum(physical_fight == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_physical_fight)) +
  geom_bar(stat = "identity", position = "dodge")

yrbss_state_tidy_physical_fight %>% 
  mutate(grade = ifelse(is.na(grade), "Missing", as.character(grade))) %>% 
  group_by(drug_use_freq, grade) %>% 
  summarize(
    prop_physical_fight = sum(physical_fight == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_physical_fight, fill = grade)) +
  geom_bar(stat = "identity", position = "dodge")

yrbss_state_tidy_physical_fight %>% 
  mutate(sex = ifelse(is.na(sex), "Missing", as.character(sex))) %>% 
  group_by(drug_use_freq, sex) %>% 
  summarize(
    prop_physical_fight = sum(physical_fight == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_physical_fight, fill = sex)) +
  geom_bar(stat = "identity", position = "dodge")

yrbss_state_tidy_physical_fight %>% 
  mutate(race4 = ifelse(is.na(race4), "Missing", as.character(race4))) %>% 
  group_by(drug_use_freq, race4) %>% 
  summarize(
    prop_physical_fight = sum(physical_fight == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_physical_fight, fill = race4)) +
  geom_bar(stat = "identity", position = "dodge")
```


### Early-age Sexual Intercourse

```{r}
yrbss_state_tidy_early_sex <- 
  yrbss_state_tidy %>%
  drop_na(q59) %>% 
  mutate(
    early_sex = ifelse(q59 > 1 & q59 < 5 , "Yes", "No")
  ) 
```



```{r}
test_of_association(yrbss_state_tidy_early_sex, "early_sex")

yrbss_state_tidy_early_sex %>%
  group_by(drug_use_freq) %>% 
  summarize(
    prop_early_sex = sum(early_sex == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_early_sex)) +
  geom_bar(stat = "identity", position = "dodge")

yrbss_state_tidy_early_sex %>% 
  mutate(grade = ifelse(is.na(grade), "Missing", as.character(grade))) %>% 
  group_by(drug_use_freq, grade) %>% 
  summarize(
    prop_early_sex = sum(early_sex == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_early_sex, fill = grade)) +
  geom_bar(stat = "identity", position = "dodge")

yrbss_state_tidy_early_sex %>% 
  mutate(sex = ifelse(is.na(sex), "Missing", as.character(sex))) %>% 
  group_by(drug_use_freq, sex) %>% 
  summarize(
    prop_early_sex = sum(early_sex == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_early_sex, fill = sex)) +
  geom_bar(stat = "identity", position = "dodge")

yrbss_state_tidy_early_sex %>% 
  mutate(race4 = ifelse(is.na(race4), "Missing", as.character(race4))) %>% 
  group_by(drug_use_freq, race4) %>% 
  summarize(
    prop_early_sex = sum(early_sex == "Yes")/n()
  ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_early_sex, fill = race4)) +
  geom_bar(stat = "identity", position = "dodge")
```


### Screening Use

```{r}
yrbss_state_tidy_screening_use <- 
  yrbss_state_tidy %>%
  drop_na(q79, q80) %>% 
  mutate(
    q79 = as.numeric(q79),
    q80 = as.numeric(q80),
    tv_use = case_when(q79 == 1 ~ 0, 
                       q79 == 2 ~ 0.5,
                       q79 > 2 ~ q79 - 2),
    computer_use = q80 - 2,
    computer_use = case_when(q80 == 1 ~ 0, 
                       q80 == 2 ~ 0.5,
                       q80 > 2 ~ q80 - 2),
    screening_use = tv_use + computer_use
  )

yrbss_state_tidy_screening_use %>% 
  group_by(drug_use_freq, screening_use) %>% 
  count() %>% 
  group_by(drug_use_freq) %>% 
  mutate(
    total = sum(n)
  ) %>% 
  ggplot(aes(x = screening_use, y = n/total)) +
  geom_bar(stat = "identity") +
  geom_smooth(se = FALSE) +
  facet_grid(.~drug_use_freq) 
```


### Smoking Status

Based on question 33 in the 2019 YOUTH RISK BEHAVIOR SURVEY, the researchers care about whether students smoked more than 10 cigarettes per day on the days they smoked during the 30 days before the survey. Therefore, we define students who did not smoke as "Never Smoker", 1 to 10 cigarettes per day as "Light Smoker", greater than 10 cigarettes per day as "Heavy Smokers".


```{r}
yrbss_state_tidy_smoking_status <- 
  yrbss_state_tidy %>% 
  drop_na(q33) %>% 
  mutate(
    smoking_status = case_when(q33 == 1 ~ "Never Smoker",
                               q33 >= 2 & q33 <= 5 ~ "Light Smoker",
                               q33 >=6 ~ "Heavy Smoker"),
    smoking_status = factor(smoking_status, level = c("Never Smoker", "Light Smoker", "Heavy Smoker"))
  ) %>% 
  select(smoking_status, drug_use_freq, grade, sex, race4)
```

Association Analysis

```{r}
# test_of_association(yrbss_state_tidy_smoking_status, "smoking_status")

yrbss_state_tidy_smoking_status %>% 
  group_by(drug_use_freq, smoking_status) %>% 
  summarize(n = n()) %>% 
  mutate(total = case_when(drug_use_freq == "No Drug Use" ~ sum(n),
                          drug_use_freq == "Light Dose" ~ sum(n),
                          drug_use_freq == "Heavy Dose" ~ sum(n)),
         prop_smoking_status = n/total
         ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_smoking_status, fill = smoking_status)) +
  geom_bar(stat = "identity", position = "dodge")

# Stratified Analysis over Grade
yrbss_state_tidy_smoking_status %>% 
  mutate(grade = ifelse(is.na(grade), "Missing", as.character(grade))) %>% 
  group_by(drug_use_freq,smoking_status,grade) %>% 
  summarize(n = n()) %>% 
  mutate(total = case_when(smoking_status == "Never Smoker" ~ sum(n),
                          smoking_status == "Light Smoker" ~ sum(n),
                          smoking_status == "Heavy Smoker" ~ sum(n)),
         prop_smoking_status = n/total
         ) %>%
  ggplot(aes(x = drug_use_freq, y = prop_smoking_status, fill = grade)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(smoking_status ~ .)

# Over Gender
yrbss_state_tidy_smoking_status %>% 
  mutate(sex = ifelse(is.na(sex), "Missing", as.character(sex))) %>% 
  group_by(drug_use_freq,smoking_status,sex) %>% 
  summarize(n = n()) %>% 
  mutate(total = case_when(smoking_status == "Never Smoker" ~ sum(n),
                          smoking_status == "Light Smoker" ~ sum(n),
                          smoking_status == "Heavy Smoker" ~ sum(n)),
         prop_smoking_status = n/total
         ) %>%
  ggplot(aes(x = drug_use_freq, y = prop_smoking_status, fill = sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(smoking_status ~ .)

# Over race
yrbss_state_tidy_smoking_status %>% 
  mutate(race4 = ifelse(is.na(race4), "Missing", as.character(race4))) %>% 
  group_by(drug_use_freq, smoking_status,race4) %>% 
  summarize(n = n()) %>% 
  mutate(total = case_when(smoking_status == "Never Smoker" ~ sum(n),
                          smoking_status == "Light Smoker" ~ sum(n),
                          smoking_status == "Heavy Smoker" ~ sum(n)),
         prop_smoking_status = n/total
         ) %>%
  ggplot(aes(x = drug_use_freq, y = prop_smoking_status, fill = race4)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(smoking_status ~ .)
```


### Binge Drinking 

Based on question 42 in the 2019 YOUTH RISK BEHAVIOR SURVEY, we define students who did not have binge drinking as "No Binge Drinking", 1 to 5 days of binge drinking in the past 30 days as "Light Binge Drinking", greater than 5days as "Heavy Binge Drinking".


```{r}
yrbss_state_tidy_binge_drinking <- 
  yrbss_state_tidy %>% 
  drop_na(q42) %>% 
  mutate(
    binge_drinking = case_when(q42 == 1 ~ "No Binge Drinking",
                               q42 >= 2 & q42 <= 4 ~ "Light Binge Drinking",
                               q42 >=5 ~ "Heavy Binge Drinking"),
    binge_drinking = factor(binge_drinking, level = c("No Binge Drinking", "Light Binge Drinking", "Heavy Binge Drinking"))
  ) %>% 
  select(binge_drinking, drug_use_freq, grade, sex, race4)
```

Association Analysis

```{r}
# test_of_association(yrbss_state_tidy_smoking_status, "smoking_status")

yrbss_state_tidy_binge_drinking %>% 
  group_by(drug_use_freq, binge_drinking) %>% 
  summarize(n = n()) %>% 
  mutate(total = case_when(drug_use_freq == "No Drug Use" ~ sum(n),
                          drug_use_freq == "Light Dose" ~ sum(n),
                          drug_use_freq == "Heavy Dose" ~ sum(n)),
         prop_binge_drinking = n/total
         ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_binge_drinking, fill = binge_drinking)) +
  geom_bar(stat = "identity", position = "dodge")

# Stratified Analysis over Grade
yrbss_state_tidy_binge_drinking %>% 
  mutate(grade = ifelse(is.na(grade), "Missing", as.character(grade))) %>% 
  group_by(drug_use_freq,binge_drinking,grade) %>% 
  summarize(n = n()) %>% 
  mutate(total = case_when(binge_drinking == "No Binge Drinking" ~ sum(n),
                          binge_drinking == "Light Binge Drinking" ~ sum(n),
                          binge_drinking == "Heavy Binge Drinking" ~ sum(n)),
         prop_binge_drinking = n/total
         ) %>%
  ggplot(aes(x = drug_use_freq, y = prop_binge_drinking, fill = grade)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(binge_drinking ~ .)

# Over Gender
yrbss_state_tidy_binge_drinking %>% 
  mutate(sex = ifelse(is.na(sex), "Missing", as.character(sex))) %>% 
  group_by(drug_use_freq,binge_drinking,sex) %>% 
  summarize(n = n()) %>% 
  mutate(total = case_when(binge_drinking == "No Binge Drinking" ~ sum(n),
                          binge_drinking == "Light Binge Drinking" ~ sum(n),
                          binge_drinking == "Heavy Binge Drinking" ~ sum(n)),
         prop_binge_drinking = n/total
         ) %>%
  ggplot(aes(x = drug_use_freq, y = prop_binge_drinking, fill = sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(binge_drinking ~ .)

# Over race
yrbss_state_tidy_binge_drinking %>% 
  mutate(race4 = ifelse(is.na(race4), "Missing", as.character(race4))) %>% 
  group_by(drug_use_freq, binge_drinking,race4) %>% 
  summarize(n = n()) %>% 
  mutate(total = case_when(binge_drinking == "No Binge Drinking" ~ sum(n),
                          binge_drinking == "Light Binge Drinking" ~ sum(n),
                          binge_drinking == "Heavy Binge Drinking" ~ sum(n)),
         prop_binge_drinking = n/total
         ) %>%
  ggplot(aes(x = drug_use_freq, y = prop_binge_drinking, fill = race4)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(binge_drinking ~ .)
```


### Seat belt use 
Resource: question 8

```{r}
yrbss_state_tidy_seat_belt <- 
  yrbss_state_tidy %>% 
  drop_na(q8) %>% 
  mutate(
    seat_belt = case_when(q8 <= 2 ~ "Never or Rarely",
                          q8 == 3 ~ "Sometimes",
                          q8 >= 4 ~ "Most of the time or Always"),
    seat_belt = factor(seat_belt, level = c("Never or Rarely", "Sometimes", "Most of the time or Always"))
  ) %>% 
  select(seat_belt, drug_use_freq, grade, sex, race4)
```

Association Analysis

```{r}
# test_of_association(yrbss_state_tidy_smoking_status, "smoking_status")

yrbss_state_tidy_seat_belt %>% 
  group_by(drug_use_freq, seat_belt) %>% 
  summarize(n = n()) %>% 
  mutate(total = case_when(drug_use_freq == "No Drug Use" ~ sum(n),
                          drug_use_freq == "Light Dose" ~ sum(n),
                          drug_use_freq == "Heavy Dose" ~ sum(n)),
         prop_seat_belt = n/total
         ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_seat_belt, fill = seat_belt)) +
  geom_bar(stat = "identity", position = "dodge")

# Stratified Analysis over Grade
yrbss_state_tidy_seat_belt %>% 
  mutate(grade = ifelse(is.na(grade), "Missing", as.character(grade))) %>% 
  group_by(drug_use_freq,seat_belt,grade) %>% 
  summarize(n = n()) %>% 
  mutate(total = case_when(seat_belt == "Never or Rarely" ~ sum(n),
                          seat_belt == "Sometimes" ~ sum(n),
                          seat_belt == "Most of the time or Always" ~ sum(n)),
         prop_seat_belt = n/total
         ) %>%
  ggplot(aes(x = drug_use_freq, y = prop_seat_belt, fill = grade)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(seat_belt ~ .)

# Over Gender
yrbss_state_tidy_seat_belt %>% 
  mutate(sex = ifelse(is.na(sex), "Missing", as.character(sex))) %>% 
  group_by(drug_use_freq,seat_belt,sex) %>% 
  summarize(n = n()) %>% 
  mutate(total = case_when(seat_belt == "Never or Rarely" ~ sum(n),
                          seat_belt == "Sometimes" ~ sum(n),
                          seat_belt == "Most of the time or Always" ~ sum(n)),
         prop_seat_belt = n/total
         ) %>%
  ggplot(aes(x = drug_use_freq, y = prop_seat_belt, fill = sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(seat_belt ~ .)

# Over race
yrbss_state_tidy_seat_belt %>% 
  mutate(race4 = ifelse(is.na(race4), "Missing", as.character(race4))) %>% 
  group_by(drug_use_freq, seat_belt,race4) %>% 
  summarize(n = n()) %>% 
  mutate(total = case_when(seat_belt == "Never or Rarely" ~ sum(n),
                          seat_belt == "Sometimes" ~ sum(n),
                          seat_belt == "Most of the time or Always" ~ sum(n)),
         prop_seat_belt = n/total
         ) %>%
  ggplot(aes(x = drug_use_freq, y = prop_seat_belt, fill = race4)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(seat_belt ~ .)
```

### Grades in school 
Resource: question 89
exclude option "None of these grades" and "Not sure"

```{r}
yrbss_state_tidy_grades_school <- 
  yrbss_state_tidy %>% 
  drop_na(q89) %>% 
  filter(q89 < 6) %>% 
  mutate(
    grades_school = case_when(q89 == 1 ~ "Mostly A's",
                       q89 == 2 ~ "Mostly B's",
                       q89 == 3 ~ "Mostly C's",
                       q89 >= 4 ~ "Mostly Below C's"),
    grades_school = factor(grades_school, level = c("Mostly A's", "Mostly B's", "Mostly C's", "Mostly Below C's"))
  ) %>% 
  select(grades_school, drug_use_freq, grade, sex, race4)
```

Association Analysis

```{r}
# test_of_association(yrbss_state_tidy_smoking_status, "smoking_status")

yrbss_state_tidy_grades_school %>% 
  group_by(drug_use_freq, grades_school) %>% 
  summarize(n = n()) %>% 
  mutate(total = case_when(drug_use_freq == "No Drug Use" ~ sum(n),
                          drug_use_freq == "Light Dose" ~ sum(n),
                          drug_use_freq == "Heavy Dose" ~ sum(n)),
         prop_grades_school = n/total
         ) %>% 
  ggplot(aes(x = drug_use_freq, y = prop_grades_school, fill = grades_school)) +
  geom_bar(stat = "identity", position = "dodge")

# Stratified Analysis over Grade
yrbss_state_tidy_grades_school %>% 
  mutate(grade = ifelse(is.na(grade), "Missing", as.character(grade))) %>% 
  group_by(drug_use_freq,grades_school,grade) %>% 
  summarize(n = n()) %>% 
  mutate(total = case_when(grades_school == "Mostly A's" ~ sum(n),
                          grades_school == "Mostly B's" ~ sum(n),
                          grades_school == "Mostly C's" ~ sum(n),
                          grades_school == "Mostly Below C's" ~ sum(n)),
         prop_grades_school = n/total
         ) %>%
  ggplot(aes(x = drug_use_freq, y = prop_grades_school, fill = grade)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(grades_school ~ .)

# Over Gender
yrbss_state_tidy_grades_school %>% 
  mutate(sex = ifelse(is.na(sex), "Missing", as.character(sex))) %>% 
  group_by(drug_use_freq,grades_school,sex) %>% 
  summarize(n = n()) %>% 
  mutate(total = case_when(grades_school == "Mostly A's" ~ sum(n),
                          grades_school == "Mostly B's" ~ sum(n),
                          grades_school == "Mostly C's" ~ sum(n),
                          grades_school == "Mostly Below C's" ~ sum(n)),
         prop_grades_school = n/total
         ) %>%
  ggplot(aes(x = drug_use_freq, y = prop_grades_school, fill = sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(grades_school ~ .)

# Over race
yrbss_state_tidy_grades_school %>% 
  mutate(race4 = ifelse(is.na(race4), "Missing", as.character(race4))) %>% 
  group_by(drug_use_freq, grades_school,race4) %>% 
  summarize(n = n()) %>% 
  mutate(total = case_when(grades_school == "Mostly A's" ~ sum(n),
                          grades_school == "Mostly B's" ~ sum(n),
                          grades_school == "Mostly C's" ~ sum(n),
                          grades_school == "Mostly Below C's" ~ sum(n)),
         prop_grades_school = n/total
         ) %>%
  ggplot(aes(x = drug_use_freq, y = prop_grades_school, fill = race4)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(grades_school ~ .)
```


#### Create dataset to generate three-line table

```{r}

```





## Part 3
##### 2，额外图  
1，吸毒各个frequency段的，吸烟初始年龄分布。  
2, .....................，喝酒初始年龄分布。  
3, ....................., bmi box plot 分男女 or 金字塔图

## Q1
```{r}
#tidy q31 smoking and q40 alcohol start age
firstage_tidy <- function(input_list){
  output <- case_when(input_list == 1 ~ "never",
                      input_list == 2 ~ "8 years old or younger",
                      input_list == 3 ~ "9 or 10 years old",
                      input_list == 4 ~ "11 or 12 years old",
                      input_list == 5 ~ "13 or 14 years old",
                      input_list == 6 ~ "15 or 16 years old",
                      input_list == 7 ~ "17 years old or older")
  return(output)
}

#function for plotting first smoke_age
drug1_smoke=
  yrbss_state_tidy %>%
  mutate(
    smoke_age = firstage_tidy(q31),
  ) %>%
  drop_na(q31)


drug1_smoke %>%
  group_by(drug_use_freq, smoke_age) %>%
  filter(smoke_age != "never") %>%
  summarize(n = n()) %>% 
  mutate(percentage = n/sum(n),
         percent = scales::percent(percentage),
         smoke_age = factor(smoke_age, 
                            levels = c("never",
                                       "8 years old or younger",
                                       "9 or 10 years old",
                                       "11 or 12 years old",
                                       "13 or 14 years old",
                                       "15 or 16 years old",
                                       "17 years old or older"))) %>% 
  ggplot(
       aes(x = drug_use_freq, y = percentage,
           fill = smoke_age)
       ) +
  geom_bar(stat = "identity",                                     
           position = "dodge") +
  scale_y_continuous(breaks = seq(0, 2, .1), 
                     label = scales::percent) +
  geom_text(aes(label = percent),                                     
            size = 3,
            position = position_dodge(0.9)) +
  scale_fill_brewer(palette = "Set2")+
  labs(title="smoke start age")


#boxplot
ggplot(drug1_smoke, 
       aes(x = factor(drug_use_freq), 
           y = age_initial_smoking,fill=factor(drug_use_freq))) +     
  geom_boxplot() +
  theme(
    axis.text.x = element_text(angle = 45, vjust = 0.5, hjust = 1),
    legend.position = "none") +
  labs(title="smoke start age")
```

## Q2-alcohol
```{r}
#function for plotting first alcohol_age
drug1_alcohol=
  yrbss_state_tidy %>%
  mutate(
    alcohol_age = firstage_tidy(q40)
  ) %>%
  drop_na(q40) %>%
  drop_na(drug_use_freq)


drug1_alcohol %>%
  group_by(drug_use_freq, alcohol_age) %>%
    filter(alcohol_age != "never") %>%
  summarize(n = n()) %>% 
  mutate(percentage = n/sum(n),
         percent = scales::percent(percentage),
         alcohol_age = factor(alcohol_age, 
                            levels = c("never",
                                       "8 years old or younger",
                                       "9 or 10 years old",
                                       "11 or 12 years old",
                                       "13 or 14 years old",
                                       "15 or 16 years old",
                                       "17 years old or older"))) %>% 
  ggplot(
       aes(x = drug_use_freq, y = percentage,
           fill = alcohol_age)
       ) +
  geom_bar(stat = "identity",                                     
           position = "dodge") +
  scale_y_continuous(breaks = seq(0, 2, .1), 
                     label = scales::percent) +
  geom_text(aes(label = percent),                                     
            size = 3,
            position = position_dodge(0.9)) +
  scale_fill_brewer(palette = "Set2")+
  labs(title="alcohol start age")

#boxplot
ggplot(drug1_alcohol, 
       aes(x = factor(drug_use_freq), 
           y = age_initial_alcohol,fill=factor(drug_use_freq))) +        
  geom_boxplot() +
  theme(
    axis.text.x = element_text(angle = 45, vjust = 0.5, hjust = 1),
    legend.position = "none") +
  labs(title="alcohol start age")

```

## Q3-BMI
```{r}
BMI =
  yrbss_state_tidy %>%
  drop_na(drug_use_freq) %>%
  drop_na(sex)

BMI %>%
  ggplot(aes(x = factor(drug_use_freq), 
           y = bmi,fill=factor(drug_use_freq))) +
  geom_boxplot() +
  facet_grid(. ~ sex) +  
  theme(
    axis.text.x = element_text(angle = 45, vjust = 0.5, hjust = 1),
    legend.position = "none")+
  labs(title = "Salary distribution by rank")

#heavy tail - more dose have higher BMI 


#pyramid plot - looks weird
ggplot(BMI, aes(x = drug_use_freq, y = ifelse(sex == "2", -bmi, bmi), fill =sex)) + 
  geom_bar(stat = "identity") +
  scale_y_continuous(labels = abs, limits = c(-200,200)) +
  coord_flip()

```


